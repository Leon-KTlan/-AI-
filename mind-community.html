<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindNote - ç¤¾åŒº</title>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6; /* Blue theme */
            --primary-color-light: #eff6ff;
            --primary-color-dark: #2563eb;
        }
        body {
            font-family: 'Noto+Sans SC', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }
        .main-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            height: 100vh;
        }
        .sidebar {
            background-color: #ffffff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1rem;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: #374151;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link i {
            width: 24px;
            text-align: center;
        }
        .sidebar-link.active, .sidebar-link:hover {
            background-color: var(--primary-color-light);
            color: var(--primary-color);
        }
        .sidebar-link.publish {
             background-color: var(--primary-color);
             color: white;
        }
        .sidebar-link.publish:hover {
             background-color: var(--primary-color-dark);
        }

        .main-content {
            overflow-y: auto;
            padding: 1.5rem 2rem;
        }
        .top-nav {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }
        .top-nav a {
            padding: 0.5rem 1rem;
            margin-bottom: -1px;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-weight: 500;
            transition: color 0.2s, border-color 0.2s;
        }
        .top-nav a.active, .top-nav a:hover {
            color: #111827;
            border-bottom-color: var(--primary-color);
        }
        
        .grid-item {
            width: calc(50% - 1rem);
            margin-bottom: 1.5rem;
            break-inside: avoid;
            transition: transform 0.2s ease;
            border-radius: 12px;
            overflow: hidden;
            background-color: white;
        }
        @media (min-width: 768px) { .grid-item { width: calc(33.333% - 1rem); } }
        @media (min-width: 1024px) { .grid-item { width: calc(25% - 1rem); } }
        @media (min-width: 1280px) { .grid-item { width: calc(20% - 1rem); } }

        .grid-item:hover { transform: translateY(-3px); }
        .grid-item img { width: 100%; height: auto; display: block; background-color: #f0f4f8; }

        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .file-input-wrapper { border: 2px dashed #d1d5db; }
        .file-input-wrapper.dragover { border-color: var(--primary-color); background-color: #eff6ff; }
        .tag { background-color: #e5e7eb; color: #4b5563; }
        .like-btn.liked { color: var(--primary-color); }
        .like-btn.liked .fa-heart { animation: heart-pop 0.5s ease; }
        @keyframes heart-pop { 0%{transform: scale(1);} 50%{transform: scale(1.3);} 100%{transform: scale(1);} }
        .loader, .ai-loader {
            width: 48px; height: 48px; border: 5px solid #f3f4f6;
            border-bottom-color: var(--primary-color);
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .ai-loader { width: 20px; height: 20px; border-width: 3px; }
        @keyframes rotation { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
        .ai-btn {
            background-color: var(--primary-color-light);
            color: var(--primary-color-dark);
        }
        .ai-btn:hover {
             background-color: #dbeafe;
        }
    </style>
</head>
<body class="w-full h-screen overflow-hidden">

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="#" class="text-2xl font-bold text-gray-800 mb-8 pl-4">
                <span class="text-blue-600">Mind</span>Note
            </a>
            <nav class="flex flex-col gap-2">
                <a href="#" class="sidebar-link active"><i class="fas fa-compass fa-fw"></i> <span>å‘ç°</span></a>
                <a href="#" id="create-post-btn" class="sidebar-link publish"><i class="fas fa-plus fa-fw"></i> <span>å‘å¸ƒ</span></a>
                <a href="#" class="sidebar-link"><i class="fas fa-bell fa-fw"></i> <span>é€šçŸ¥</span></a>
                <a href="#" class="sidebar-link"><i class="fas fa-user fa-fw"></i> <span>æˆ‘</span></a>
            </nav>
            <div class="mt-auto pl-4">
                 <a href="#" class="text-sm text-gray-500 hover:text-gray-800"><i class="fas fa-cog mr-2"></i> è®¾ç½®</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-nav">
                <a href="#" class="active">æ¨è</a>
                <a href="#">å¿ƒç†</a>
                <a href="#">æ²»æ„ˆ</a>
                <a href="#">å†¥æƒ³</a>
                <a href="#">æƒ…æ„Ÿ</a>
                <a href="#">æˆé•¿</a>
                <a href="#">ç©¿æ­</a>
                <a href="#">ç¾é£Ÿ</a>
                <a href="#">æ—…è¡Œ</a>
            </header>
            <!-- æœç´¢æ¡†ï¼šå±…ä¸­æ˜¾ç¤º -->
            <div class="flex justify-center my-6">
              <input
                type="text"
                id="search-input"
                placeholder="æœç´¢MindNote"
                class="w-full max-w-md px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"
              />
            </div>
            <div id="loading-indicator" class="text-center py-20">
                <div class="max-w-md mx-auto">
                    <div class="mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 relative">
                            <div class="w-full h-full border-4 border-blue-200 rounded-full animate-pulse"></div>
                            <div class="absolute inset-2 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-heart text-white text-lg"></i>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">æ­£åœ¨ä¸ºæ‚¨ç²¾å¿ƒå‡†å¤‡å†…å®¹</h3>
                        <p class="text-sm text-gray-500 mb-6">å‘ç°æ›´å¤šæ¸©æš–çš„å¿ƒç†æ•…äº‹...</p>
                    </div>
                    
                    <!-- è¿›åº¦æ¡ -->
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                        <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                    
                    <!-- è¿›åº¦ç™¾åˆ†æ¯”å’Œæç¤ºæ–‡å­— -->
                    <div class="flex justify-between items-center text-sm">
                        <span id="progress-text" class="text-gray-600">å‡†å¤‡ä¸­...</span>
                        <span id="progress-percentage" class="font-bold text-blue-600">0%</span>
                    </div>
                </div>
            </div>
            <div id="grid" class="opacity-0 transition-opacity duration-500">
                <!-- Masonry grid items will be injected here -->
            </div>
            <!-- <div id="image-stats" class="text-center py-6 text-sm text-gray-500 opacity-0 transition-all duration-700">
                <div class="flex items-center justify-center gap-4 mb-2">
                    <span><span id="loaded-images-count">0</span> / <span id="total-images-count">0</span> å¼ å›¾ç‰‡å·²åŠ è½½</span>
                    <button id="load-all-images-btn" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors hidden">
                        åŠ è½½å…¨éƒ¨å›¾ç‰‡
                    </button>
                </div>
                <p class="text-xs text-gray-400">ğŸ’¡ ç‚¹å‡»å›¾ç‰‡æˆ–æ»šåŠ¨é¡µé¢è‡ªåŠ¨åŠ è½½ï¼ŒèŠ‚çœæµé‡</p>
            </div> -->
        </main>
    </div>

    <!-- Create Post Modal -->
    <div id="create-post-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4 modal">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl modal-content transform scale-95 opacity-0">
             <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">å‘å¸ƒæ–°ç¬”è®°</h2>
                <button id="close-create-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <form id="create-post-form" class="p-6">
                <div id="file-input-wrapper" class="file-input-wrapper w-full h-48 rounded-xl flex flex-col items-center justify-center mb-4 cursor-pointer text-center">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                    <p class="font-semibold text-gray-600">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
                    <p class="text-sm text-gray-400">æ”¯æŒ JPG, PNG, GIF</p>
                    <input type="file" id="image-upload" class="sr-only" accept="image/*">
                </div>
                <div id="image-preview" class="hidden mb-4 rounded-xl overflow-hidden relative">
                    <img id="preview-img" src="" alt="Image preview" class="max-h-64 w-auto mx-auto">
                    <button type="button" id="ai-suggestion-btn" class="absolute top-3 right-3 ai-btn px-3 py-2 text-sm rounded-full shadow-lg flex items-center gap-2" disabled>
                        <span id="ai-btn-icon">âœ¨</span>
                        <span id="ai-btn-text">AI ç”Ÿæˆå»ºè®®</span>
                        <div id="ai-btn-loader" class="ai-loader hidden"></div>
                    </button>
                </div>
                <div class="mb-4">
                    <input type="text" id="post-nickname" placeholder="ç•™ä¸‹ä½ çš„åŒ¿åæ˜µç§°" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <input type="text" id="post-title" placeholder="å¡«å†™æ ‡é¢˜ï¼Œä¼šè·å¾—æ›´å¤šèµå“¦ï½" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <textarea id="post-content" rows="4" placeholder="è¯´è¯´è¿™ç¯‡ç¬”è®°çš„çµæ„Ÿæ¥æº..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                </div>
                <div class="mb-6">
                    <input type="text" id="post-tags" placeholder="æ·»åŠ æ ‡ç­¾ï¼Œè®©æ›´å¤šäººçœ‹åˆ°ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" id="submit-post-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center disabled:bg-blue-300" disabled>
                    <span id="submit-btn-text">å‘å¸ƒç¬”è®°</span>
                    <div id="submit-spinner" class="loader !w-6 !h-6 !border-4 hidden"></div>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Post Detail Modal -->
    <div id="post-detail-modal" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-md hidden items-center justify-center p-4 modal">
         <button id="close-detail-modal-btn" class="absolute top-4 right-4 text-white/70 hover:text-white text-4xl z-10">&times;</button>
         <div id="post-detail-content" class="w-full h-full flex items-center justify-center">
            <!-- Detail content injected by JS -->
         </div>
    </div>

    <!-- Masonry and imagesLoaded scripts -->
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_PROJECT_ID.appspot.com",
          messagingSenderId: "YOUR_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        const grid = document.getElementById('grid');
        const loadingIndicator = document.getElementById('loading-indicator');
        const createPostBtn = document.getElementById('create-post-btn');
        const createModal = document.getElementById('create-post-modal');
        const closeCreateModalBtn = document.getElementById('close-create-modal-btn');
        const createForm = document.getElementById('create-post-form');
        const imageUpload = document.getElementById('image-upload');
        const fileInputWrapper = document.getElementById('file-input-wrapper');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const submitPostBtn = document.getElementById('submit-post-btn');
        const submitBtnText = document.getElementById('submit-btn-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const aiSuggestionBtn = document.getElementById('ai-suggestion-btn');
        const detailModal = document.getElementById('post-detail-modal');
        const closeDetailModalBtn = document.getElementById('close-detail-modal-btn');
        const detailContent = document.getElementById('post-detail-content');
        const loadedImagesCountEl = document.getElementById('loaded-images-count');
        const totalImagesCountEl = document.getElementById('total-images-count');
        const loadAllImagesBtn = document.getElementById('load-all-images-btn');

        let masonry;
        
        // --- DeepSeek API Call ---
        const DEEPSEEK_API_KEY = 'sk-81ddae2501354967acd07fe6271203c1';
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';

        async function callDeepSeekAPI(prompt, base64ImageData = null) {
            const messages = [{ role: "user", content: prompt }];
            if (base64ImageData) {
                messages[0].content = [
                    { type: "text", text: prompt },
                    { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64ImageData}` } }
                ];
            }

            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: messages,
                    })
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API request failed with status ${response.status}`);
                }
                const result = await response.json();
                if (result.choices && result.choices.length > 0) {
                    return result.choices[0].message.content;
                } else {
                    throw new Error("Invalid API response format");
                }
            } catch (error) {
                console.error("Error calling DeepSeek API:", error);
                alert("AIåŠŸèƒ½è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥æˆ–ç½‘ç»œåé‡è¯•ã€‚");
                return null;
            }
        }

        // --- Mock Data with optimized Unsplash links ---
        const mockPosts = [
            {
                id: 'mock1',
                imageUrl: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "3åˆ†é’Ÿå†¥æƒ³ï¼Œè®©å†…å¿ƒç¬é—´å¹³é™ä¸‹æ¥",
                author: { displayName: "å¿ƒç†å¸ˆå°é›¨" },
                likes: 892
            },
            {
                id: 'mock2',
                imageUrl: "https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "æ‹¥æŠ±è‡ªå·±çš„ä¸å®Œç¾ï¼Œæ˜¯æœ€æ¸©æŸ”çš„è‡ªæ„ˆ",
                author: { displayName: "æ²»æ„ˆç³»é˜¿æ¡ƒ" },
                likes: 1205
            },
            {
                id: 'mock3',
                imageUrl: "https://images.unsplash.com/photo-1518837695005-2083093ee35b?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "ç„¦è™‘ç—‡æ‚£è€…çš„è‡ªæ•‘æŒ‡å—ï¼šä»ç»æœ›åˆ°é‡ç”Ÿ",
                author: { displayName: "å¿ƒçµæ‘†æ¸¡äºº" },
                likes: 687
            },
            {
                id: 'mock4',
                imageUrl: "https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "æ¯å¤©5åˆ†é’Ÿæ—¥è½å†¥æƒ³ï¼Œæ‰¾å›å†…å¿ƒçš„å®é™",
                author: { displayName: "å¤•é˜³æ²»æ„ˆå¸ˆ" },
                likes: 456
            },
            {
                id: 'mock5',
                imageUrl: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "å†™ç»™æ·±å¤œå¤±çœ çš„ä½ ï¼šæ¸©æŸ”çš„æ™šå®‰å¿ƒç†å­¦",
                author: { displayName: "æœˆäº®çŸ¥å¿ƒå§" },
                likes: 934
            },
            {
                id: 'mock6',
                imageUrl: "https://images.unsplash.com/photo-1549068106-b024baf5062d?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "è¢«åŸç”Ÿå®¶åº­ä¼¤å®³åï¼Œæˆ‘å­¦ä¼šäº†è¿™æ ·çˆ±è‡ªå·±",
                author: { displayName: "å¿ƒç†æˆé•¿è®°" },
                likes: 1567
            },
            {
                id: 'mock7',
                imageUrl: "https://images.unsplash.com/photo-1585776245991-cf89dd7fc73a?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "æƒ…ç»ªä½è½æ—¶ï¼Œè¯•è¯•è¿™ä¸ªç¥å¥‡çš„å‘¼å¸æ³•",
                author: { displayName: "å‘¼å¸æ²»æ„ˆå¸ˆ" },
                likes: 723
            },
            {
                id: 'mock8',
                imageUrl: "https://images.unsplash.com/photo-1499209974431-9dddcece7f88?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "æŠ‘éƒç—‡åº·å¤æ—¥è®°ï¼šé˜³å…‰ç»ˆäºç…§è¿›æˆ‘å¿ƒé‡Œ",
                author: { displayName: "å‘é˜³è€Œç”Ÿ" },
                likes: 2134
            },
            {
                id: 'mock9',
                imageUrl: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "æ£®æ—ç–—æ³•ï¼šå¤§è‡ªç„¶æ˜¯æœ€å¥½çš„å¿ƒç†åŒ»ç”Ÿ",
                author: { displayName: "è‡ªç„¶ç–—æ„ˆå¸ˆ" },
                likes: 589
            },
            {
                id: 'mock10',
                imageUrl: "https://images.unsplash.com/photo-1508739773434-c26b3d09e071?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "ç¤¾äº¤ææƒ§ç—‡çš„æˆ‘ï¼Œå¦‚ä½•åœ¨äººç¾¤ä¸­æ‰¾åˆ°è‡ªä¿¡",
                author: { displayName: "å‹‡æ•¢å°èœ—ç‰›" },
                likes: 445
            },
            {
                id: 'mock11',
                imageUrl: "https://images.unsplash.com/photo-1574680096145-d05b474e2155?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "é‚£äº›æ²»æ„ˆå¿ƒçµçš„å°ç¡®å¹¸æ—¶åˆ»",
                author: { displayName: "å°ç¡®å¹¸æ”¶é›†è€…" },
                likes: 812
            },
            {
                id: 'mock12',
                imageUrl: "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "å­¦ä¼šä¸å†…å¿ƒçš„å£°éŸ³å’Œè§£ï¼Œæ˜¯æˆé•¿çš„å¼€å§‹",
                author: { displayName: "å†…å¿ƒå¯¹è¯å¸ˆ" },
                likes: 976
            },
            {
                id: 'mock13',
                imageUrl: "https://images.unsplash.com/photo-1524863479829-916d8e77f114?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "å½“æƒ…ç»ªæ¥ä¸´æ—¶ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ä¸å®ƒå…±èˆ",
                author: { displayName: "æƒ…ç»ªèˆè€…" },
                likes: 634
            },
            {
                id: 'mock14',
                imageUrl: "https://images.unsplash.com/photo-1456324504439-367cee3b3c32?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "å¿ƒç†è¾¹ç•Œï¼šå­¦ä¼šè¯´ä¸ï¼Œæ˜¯å¯¹è‡ªå·±æœ€å¥½çš„ä¿æŠ¤",
                author: { displayName: "è¾¹ç•Œå®ˆæŠ¤è€…" },
                likes: 1089
            },
            {
                id: 'mock15',
                imageUrl: "https://images.unsplash.com/photo-1560472354-b33ff0c44a43?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "ä»å®Œç¾ä¸»ä¹‰åˆ°è‡ªæˆ‘æ¥çº³ï¼šæˆ‘çš„å¿ƒè·¯å†ç¨‹",
                author: { displayName: "å®Œç¾ä¸»ä¹‰åº·å¤è€…" },
                likes: 756
            },
            {
                id: 'mock16',
                imageUrl: "https://images.unsplash.com/photo-1426604966848-d7adac402bff?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "å¤§å±±æ•™ä¼šæˆ‘çš„å¿ƒç†å­¦ï¼šå®é™è‡´è¿œ",
                author: { displayName: "å±±é‡Œæ¥çš„å¿ƒç†å¸ˆ" },
                likes: 423
            },
            {
                id: 'mock17',
                imageUrl: "https://images.unsplash.com/photo-1505142468610-359e7d316be0?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "å­¤ç‹¬ä¸æ˜¯ç—…ï¼Œä½†å­¦ä¼šç‹¬å¤„æ˜¯ç§èƒ½åŠ›",
                author: { displayName: "ç‹¬å¤„è‰ºæœ¯å®¶" },
                likes: 1198
            },
            {
                id: 'mock18',
                imageUrl: "https://images.unsplash.com/photo-1547036967-23d11aacaee0?q=60&w=400&auto=format&fit=crop&dpr=1",
                title: "æ¸©æŸ”çš„è‡ªæˆ‘å¯¹è¯ï¼šæ”¹å˜ä»å†…å¿ƒå¼€å§‹",
                author: { displayName: "æ¸©æŸ”çš„å¿ƒç†å¯¼å¸ˆ" },
                likes: 867
            }
        ];
        
        function initMasonry() { masonry = new Masonry(grid, { itemSelector: '.grid-item', gutter: 16, percentPosition: true }); }
        function getLikedPosts() { return JSON.parse(localStorage.getItem('mindNoteLikes') || '[]'); }
        function isPostLiked(postId) { return getLikedPosts().includes(postId); }
        function toggleLocalLike(postId) {
            let likedPosts = getLikedPosts();
            if (isPostLiked(postId)) {
                likedPosts = likedPosts.filter(id => id !== postId);
            } else {
                likedPosts.push(postId);
            }
            localStorage.setItem('mindNoteLikes', JSON.stringify(likedPosts));
        }
        
        function createPostElement(post, loadImage = false) {
            const postEl = document.createElement('div');
            postEl.className = 'grid-item bg-white cursor-pointer';
            postEl.dataset.id = post.id;
            
            // å§‹ç»ˆå…ˆæ˜¾ç¤ºæ–‡å­—å†…å®¹ï¼Œå›¾ç‰‡ä½ç½®ç”¨å ä½ç¬¦
            postEl.innerHTML = `
                <div class="relative bg-gray-100" style="min-height: 200px; aspect-ratio: 4/3;">
                    <img 
                        src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PGNpcmNsZSBjeD0iNTAlIiBjeT0iNDUlIiByPSIyMCIgZmlsbD0iI2Q1ZDlkZiIvPjxwYXRoIGQ9Im0yMDUgNDcuNSA3LjUgNy41LTcuNSA3LjUiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+PHRleHQgeD0iNTAlIiB5PSI3NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+è½»è§¦åŠ è½½å›¾ç‰‡</text></svg>" 
                        alt="${post.title}" 
                        data-src="${post.imageUrl}"
                        class="lazy-image w-full h-full object-cover cursor-pointer transition-opacity duration-300"
                        style="opacity: 1;"
                    >
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                        <div class="bg-white/90 rounded-full p-2">
                            <i class="fas fa-image text-gray-600"></i>
                        </div>
                    </div>
                </div>
                <div class="p-3">
                    <h3 class="font-semibold text-sm text-gray-800 mb-2">${post.title}</h3>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                         <div class="flex items-center gap-2">
                             <span>${post.author.displayName}</span>
                         </div>
                         <div class="flex items-center gap-1 ${isPostLiked(post.id) ? 'text-blue-600' : ''}">
                             <i class="fa-solid fa-heart"></i>
                             <span>${post.likes || 0}</span>
                         </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ ç‚¹å‡»åŠ è½½å›¾ç‰‡åŠŸèƒ½
            const img = postEl.querySelector('.lazy-image');
            img.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»
                loadImageForElement(img);
            });
            
            postEl.addEventListener('click', () => showPostDetail(post));
            
            // å¦‚æœæŒ‡å®šè¦ç«‹å³åŠ è½½å›¾ç‰‡ï¼Œåˆ™åŠ è½½
            if (loadImage) {
                setTimeout(() => loadImageForElement(img), 100);
            }
            
            return postEl;
        }

        function loadImageForElement(imgElement) {
            if (!imgElement.dataset.src || imgElement.dataset.loaded === 'true') return;
            
            const realImageUrl = imgElement.dataset.src;
            imgElement.dataset.loaded = 'true';
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            imgElement.style.opacity = '0.6';
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-gray-100/80';
            loadingDiv.innerHTML = '<div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>';
            imgElement.parentElement.appendChild(loadingDiv);
            
            // é¢„åŠ è½½çœŸå®å›¾ç‰‡
            const tempImg = new Image();
            tempImg.onload = () => {
                imgElement.src = realImageUrl;
                imgElement.style.opacity = '1';
                loadingDiv.remove();
                // æ›´æ–°ç»Ÿè®¡
                updateImageStats();
                // æ›´æ–° masonry å¸ƒå±€
                if (masonry) {
                    setTimeout(() => masonry.layout(), 100);
                }
            };
            
            tempImg.onerror = () => {
                loadingDiv.remove();
                imgElement.style.opacity = '1';
                // æ›´æ–°ç»Ÿè®¡ï¼ˆå³ä½¿åŠ è½½å¤±è´¥ä¹Ÿç®—ä½œå·²å¤„ç†ï¼‰
                updateImageStats();
                // ä¿æŒå ä½ç¬¦å›¾ç‰‡
            };
            
            tempImg.src = realImageUrl;
        }

        let allPostsData = [];

        function updateImageStats() {
            const totalImages = allPostsData.length;
            const loadedImages = grid.querySelectorAll('.lazy-image[data-loaded="true"]').length;
            loadedImagesCountEl.textContent = loadedImages;
            totalImagesCountEl.textContent = totalImages;
            
            // æ˜¾ç¤ºæˆ–éšè—"åŠ è½½å…¨éƒ¨å›¾ç‰‡"æŒ‰é’®
            if (totalImages > 0 && loadedImages < totalImages) {
                loadAllImagesBtn.classList.remove('hidden');
            } else {
                loadAllImagesBtn.classList.add('hidden');
            }
        }

        let isInitialLoad = true;
        let fakeProgressInterval;

        function startFakeProgress() {
            console.log('å¯åŠ¨è™šå‡è¿›åº¦æ¡...'); // è°ƒè¯•ä¿¡æ¯
            
            // æ¸…é™¤ä»»ä½•ç°æœ‰çš„è¿›åº¦æ¡å®šæ—¶å™¨
            if (fakeProgressInterval) {
                clearInterval(fakeProgressInterval);
                fakeProgressInterval = null;
            }
            
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressPercentage = document.getElementById('progress-percentage');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!progressBar || !progressText || !progressPercentage) {
                console.error('è¿›åº¦æ¡å…ƒç´ æœªæ‰¾åˆ°:', { progressBar, progressText, progressPercentage });
                // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥å®ŒæˆåŠ è½½
                setTimeout(completeLoading, 1000);
                return;
            }
            
            console.log('è¿›åº¦æ¡å…ƒç´ æ‰¾åˆ°ï¼Œå¼€å§‹æ›´æ–°è¿›åº¦...');
            
            let progress = 1; // ä»1%å¼€å§‹
            
            // å®šä¹‰ä¸åŒé˜¶æ®µçš„æç¤ºæ–‡å­—
            const stages = [
                { threshold: 0, text: "æ­£åœ¨è¿æ¥å¿ƒç†ç¤¾åŒº..." },
                { threshold: 10, text: "åŠ è½½æ¸©æš–æ•…äº‹æ•°æ®..." },
                { threshold: 25, text: "è·å–ä¸ªæ€§åŒ–æ¨è..." },
                { threshold: 40, text: "å‡†å¤‡æ²»æ„ˆå†…å®¹..." },
                { threshold: 55, text: "ä¼˜åŒ–é˜…è¯»ä½“éªŒ..." },
                { threshold: 70, text: "åŒæ­¥ç”¨æˆ·åå¥½..." },
                { threshold: 85, text: "æœ€åçš„æ¶¦è‰²..." },
                { threshold: 95, text: "é©¬ä¸Šå°±å¥½..." }
            ];
            
            function updateProgress() {
                // æ¨¡æ‹ŸçœŸå®çš„ä¸å‡åŒ€è¿›åº¦å¢é•¿
                let increment;
                if (progress < 15) {
                    increment = Math.random() * 1.5 + 0.8; // å¼€å§‹è¾ƒå¿«
                } else if (progress < 75) {
                    increment = Math.random() * 1.2 + 0.6; // ä¸­é—´ç¨³å®š
                } else if (progress < 92) {
                    increment = Math.random() * 0.8 + 0.4; // åæœŸè¾ƒæ…¢
                } else {
                    increment = Math.random() * 0.5 + 0.2; // æœ€åå¾ˆæ…¢ï¼Œå¢åŠ çœŸå®æ„Ÿ
                }
                
                progress = Math.min(progress + increment, 100);
                
                // æ›´æ–°è¿›åº¦æ¡
                progressBar.style.width = progress + '%';
                progressPercentage.textContent = Math.floor(progress) + '%';
                
                // æ›´æ–°æç¤ºæ–‡å­—
                for (let i = stages.length - 1; i >= 0; i--) {
                    if (progress >= stages[i].threshold) {
                        progressText.textContent = stages[i].text;
                        break;
                    }
                }
                
                // æ¯éš”5%è¾“å‡ºä¸€æ¬¡è°ƒè¯•ä¿¡æ¯
                if (Math.floor(progress) % 5 === 0 && Math.floor(progress) !== Math.floor(progress - increment)) {
                    console.log(`è¿›åº¦æ›´æ–°: ${Math.floor(progress)}%`);
                }
                
                // å¦‚æœè¿›åº¦è¾¾åˆ°100%ï¼Œå®ŒæˆåŠ è½½
                if (progress >= 100) {
                    clearInterval(fakeProgressInterval);
                    fakeProgressInterval = null;
                    progressText.textContent = "åŠ è½½å®Œæˆï¼";
                    console.log('è¿›åº¦æ¡å®Œæˆï¼Œå‡†å¤‡æ˜¾ç¤ºå†…å®¹...');
                    setTimeout(() => {
                        completeLoading();
                    }, 800);
                }
            }
            
            // åˆå§‹è®¾ç½®
            progressBar.style.width = '1%';
            progressPercentage.textContent = '1%';
            progressText.textContent = stages[0].text;
            
            // æ¯150msæ›´æ–°ä¸€æ¬¡ï¼Œæ€»å…±çº¦20ç§’
            fakeProgressInterval = setInterval(updateProgress, 150);
        }

        function completeLoading() {
            // æ¸…é™¤è¿›åº¦æ¡å®šæ—¶å™¨
            if (fakeProgressInterval) {
                clearInterval(fakeProgressInterval);
                fakeProgressInterval = null;
            }
            
            // æ·»åŠ æ·¡å‡ºæ•ˆæœ
            loadingIndicator.style.transition = 'opacity 0.5s ease-out';
            loadingIndicator.style.opacity = '0';
            
            setTimeout(() => {
                loadingIndicator.classList.add('hidden');
                loadingIndicator.style.opacity = '1'; // é‡ç½®é€æ˜åº¦
                
                // æ¸²æŸ“æœ€ç»ˆå†…å®¹
                filterAndRenderPosts();
                
                // æ˜¾ç¤ºæ¬¢è¿æç¤º
                setTimeout(() => {
                    showWelcomeToast();
                }, 800);
                
            }, 500);
        }

        function showWelcomeToast() {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            toast.innerHTML = '<i class="fas fa-heart mr-2"></i>æ¬¢è¿æ¥åˆ°å¿ƒç†ç¤¾åŒº ğŸ’š';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function renderPosts(posts) {
            allPostsData = [...mockPosts, ...posts];
            grid.innerHTML = '';
            
            // ç«‹å³æ˜¾ç¤ºæ‰€æœ‰æ–‡å­—å†…å®¹
            allPostsData.forEach(post => {
                const postEl = createPostElement(post, false); // ä¸ç«‹å³åŠ è½½å›¾ç‰‡
                grid.appendChild(postEl);
            });
            
            // æ›´æ–°ç»Ÿè®¡
            updateImageStats();
            
            // å¦‚æœè¿›åº¦æ¡æ­£åœ¨è¿è¡Œï¼Œåªå‡†å¤‡å†…å®¹ä½†ä¸æ˜¾ç¤º
            if (fakeProgressInterval) {
                // åˆå§‹åŒ–masonryä½†ä¸æ˜¾ç¤ºå†…å®¹
                if (!masonry) {
                    initMasonry();
                } else {
                    masonry.reloadItems();
                    masonry.layout();
                }
                return;
            }
            
            // è¿›åº¦æ¡å·²å®Œæˆæˆ–éé¦–æ¬¡åŠ è½½ï¼Œç›´æ¥æ˜¾ç¤º
            setTimeout(() => {
                if (!masonry) {
                    initMasonry();
                } else {
                    masonry.reloadItems();
                    masonry.layout();
                }
                
                loadingIndicator.classList.add('hidden');
                
                // å†…å®¹æ·¡å…¥æ•ˆæœ
                grid.style.transition = 'opacity 0.6s ease-in';
                grid.classList.remove('opacity-0');
                
                // æ˜¾ç¤ºåº•éƒ¨ç»Ÿè®¡ä¿¡æ¯
                const imageStats = document.getElementById('image-stats');
                setTimeout(() => {
                    imageStats.classList.remove('opacity-0');
                }, 400);
                
                loadImagesInViewport();
            }, 100);
        }

        // åŠ è½½å½“å‰è§†çª—å†…çš„å›¾ç‰‡
        function loadImagesInViewport() {
            const viewportHeight = window.innerHeight;
            const images = grid.querySelectorAll('.lazy-image[data-src]:not([data-loaded="true"])');
            
            images.forEach(img => {
                const rect = img.getBoundingClientRect();
                // å¦‚æœå›¾ç‰‡åœ¨è§†çª—å†…æˆ–å³å°†è¿›å…¥è§†çª—
                if (rect.top < viewportHeight + 200) {
                    loadImageForElement(img);
                }
            });
        }





        // æ·»åŠ  Intersection Observer æ¥ä¼˜åŒ–å›¾ç‰‡åŠ è½½
        let imageObserver;
        if ('IntersectionObserver' in window) {
            imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                            imageObserver.unobserve(img);
                        }
                    }
                });
            }, {
                rootMargin: '50px' // æå‰50pxå¼€å§‹åŠ è½½
            });
        }
        
        // ç«‹å³å¯åŠ¨è¿›åº¦æ¡ï¼ˆä¸ç­‰Firebaseå’Œä»»ä½•å¼‚æ­¥æ“ä½œï¼‰
        console.log('é¡µé¢å¼€å§‹åŠ è½½ï¼Œå‡†å¤‡å¯åŠ¨è¿›åº¦æ¡...');
        if (isInitialLoad) {
            // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿DOMå…ƒç´ å·²å‡†å¤‡å¥½
            setTimeout(() => {
                startFakeProgress();
                isInitialLoad = false;
            }, 100);
        }
        
        const postsCol = collection(db, 'posts');
        let allRealtimePosts = [];
        
        // ä¿®æ”¹onSnapshotï¼Œä¿å­˜æ‰€æœ‰å®æ—¶å¸–å­
        onSnapshot(postsCol, (snapshot) => {
            const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            posts.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            allRealtimePosts = posts;
            
            // å¦‚æœè¿›åº¦æ¡è¿˜åœ¨è¿è¡Œï¼Œä¸è¦ç«‹å³æ¸²æŸ“
            if (fakeProgressInterval) {
                // å°†æ•°æ®ä¿å­˜ï¼Œç­‰è¿›åº¦æ¡å®Œæˆåå†æ¸²æŸ“
                return;
            }
            
            filterAndRenderPosts();
        });
        // æœç´¢è¿‡æ»¤å‡½æ•°
        function filterAndRenderPosts() {
            const keyword = document.getElementById('search-input').value.trim().toLowerCase();
            let filtered = allRealtimePosts;
            if (keyword) {
                filtered = allRealtimePosts.filter(post => {
                    return (
                        (post.title && post.title.toLowerCase().includes(keyword)) ||
                        (post.content && post.content.toLowerCase().includes(keyword)) ||
                        (post.author && post.author.displayName && post.author.displayName.toLowerCase().includes(keyword))
                    );
                });
            }
            renderPosts(filtered);
        }
        // ç›‘å¬æœç´¢è¾“å…¥
        document.getElementById('search-input').addEventListener('input', filterAndRenderPosts);
        
        // æ·»åŠ æ»šåŠ¨ç›‘å¬å™¨å®ç°å›¾ç‰‡æ‡’åŠ è½½
        window.addEventListener('scroll', () => {
            loadImagesInViewport();
        });

        // åŠ è½½å…¨éƒ¨å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        loadAllImagesBtn.addEventListener('click', () => {
            const unloadedImages = grid.querySelectorAll('.lazy-image[data-src]:not([data-loaded="true"])');
            unloadedImages.forEach(img => {
                loadImageForElement(img);
            });
            loadAllImagesBtn.textContent = 'åŠ è½½ä¸­...';
            loadAllImagesBtn.disabled = true;
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´åæ¢å¤æŒ‰é’®ï¼ˆå¦‚æœè¿˜æœ‰æœªåŠ è½½çš„å›¾ç‰‡ï¼‰
            setTimeout(() => {
                loadAllImagesBtn.textContent = 'åŠ è½½å…¨éƒ¨å›¾ç‰‡';
                loadAllImagesBtn.disabled = false;
                updateImageStats(); // é‡æ–°æ£€æŸ¥ç»Ÿè®¡ä»¥å†³å®šæ˜¯å¦éšè—æŒ‰é’®
            }, 2000);
        });
        
        let imageFile = null;
        function openCreateModal() {
            createModal.classList.remove('hidden');
            createModal.classList.add('flex');
            setTimeout(() => createModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'), 10);
        }
        function closeCreateModal() {
            createModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                createModal.classList.add('hidden');
                createModal.classList.remove('flex');
                createForm.reset();
                imageFile = null;
                imagePreview.classList.add('hidden');
                fileInputWrapper.classList.remove('hidden');
                submitPostBtn.disabled = true;
                aiSuggestionBtn.disabled = true;
            }, 300);
        }
        
        createPostBtn.addEventListener('click', openCreateModal);
        closeCreateModalBtn.addEventListener('click', closeCreateModal);
        createModal.addEventListener('click', (e) => e.target === createModal && closeCreateModal());
        
        fileInputWrapper.addEventListener('dragover', (e) => { e.preventDefault(); fileInputWrapper.classList.add('dragover'); });
        fileInputWrapper.addEventListener('dragleave', () => fileInputWrapper.classList.remove('dragover'));
        fileInputWrapper.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInputWrapper.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });
        fileInputWrapper.addEventListener('click', () => imageUpload.click());
        imageUpload.addEventListener('change', (e) => e.target.files.length > 0 && handleFile(e.target.files[0]));

        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                imageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    fileInputWrapper.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    aiSuggestionBtn.disabled = false;
                    checkFormValidity();
                }
                reader.readAsDataURL(file);
            }
        }

        createForm.addEventListener('input', checkFormValidity);
        function checkFormValidity() {
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const nickname = document.getElementById('post-nickname').value;
            submitPostBtn.disabled = !(title && content && nickname && imageFile);
        }
        
        aiSuggestionBtn.addEventListener('click', async () => {
            if (!imageFile) return;

            const aiBtnIcon = document.getElementById('ai-btn-icon');
            const aiBtnText = document.getElementById('ai-btn-text');
            const aiBtnLoader = document.getElementById('ai-btn-loader');
            
            aiBtnIcon.classList.add('hidden');
            aiBtnLoader.classList.remove('hidden');
            aiBtnText.textContent = 'ç”Ÿæˆä¸­...';
            aiSuggestionBtn.disabled = true;

            const reader = new FileReader();
            reader.readAsDataURL(imageFile);
            reader.onloadend = async () => {
                const base64String = reader.result.split(',')[1];
                const prompt = "ä½ æ˜¯ä¸€ä½å¯Œæœ‰åˆ›é€ åŠ›çš„ç¤¾äº¤åª’ä½“ä¸“å®¶ã€‚è¯·åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œå¹¶ä»¥JSONæ ¼å¼è¿”å›ä¸€ä¸ªå»ºè®®çš„æ ‡é¢˜ï¼ˆtitleï¼‰ï¼Œä¸€æ®µå¸å¼•äººçš„æè¿°ï¼ˆcontentï¼‰ï¼Œä»¥åŠä¸€ä¸ªåŒ…å«3ä¸ªç›¸å…³æ ‡ç­¾çš„æ•°ç»„ï¼ˆtagsï¼‰ã€‚é£æ ¼è¦æ–‡è‰ºã€ç®€çŸ­ã€æœ‰å¸å¼•åŠ›ã€‚è¿”å›çš„JSONå¿…é¡»ä¸¥æ ¼éµå®ˆæ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½•markdownæ ‡è®°ã€‚";
                const resultText = await callDeepSeekAPI(prompt, base64String);

                if (resultText) {
                    try {
                        const cleanedText = resultText.replace(/```json\n?|\n?```/g, '');
                        const suggestions = JSON.parse(cleanedText);
                        document.getElementById('post-title').value = suggestions.title;
                        document.getElementById('post-content').value = suggestions.content;
                        document.getElementById('post-tags').value = suggestions.tags.join(', ');
                        checkFormValidity();
                    } catch (e) {
                        console.error("Failed to parse AI response:", e, "Raw text:", resultText);
                        alert("AIè¿”å›çš„æ ¼å¼æœ‰è¯¯ï¼Œè¯·æ‰‹åŠ¨å¡«å†™æˆ–é‡è¯•ã€‚");
                    }
                }

                aiBtnIcon.classList.remove('hidden');
                aiBtnLoader.classList.add('hidden');
                aiBtnText.textContent = 'AI ç”Ÿæˆå»ºè®®';
                aiSuggestionBtn.disabled = false;
            };
        });

        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (submitPostBtn.disabled) return;
            submitSpinner.classList.remove('hidden');
            submitBtnText.classList.add('hidden');
            submitPostBtn.disabled = true;

            try {
                const storageRef = ref(storage, `posts/${Date.now()}_${imageFile.name}`);
                const snapshot = await uploadBytes(storageRef, imageFile);
                const imageUrl = await getDownloadURL(snapshot.ref);
                const nickname = document.getElementById('post-nickname').value;
                const title = document.getElementById('post-title').value;
                const content = document.getElementById('post-content').value;
                const tagsRaw = document.getElementById('post-tags').value;
                const tags = tagsRaw.split(',').map(tag => tag.trim()).filter(Boolean);
                await addDoc(postsCol, { title, content, tags, imageUrl, author: { displayName: nickname }, likes: 0, createdAt: new Date() });
                closeCreateModal();
            } catch (error) {
                console.error("Error creating post: ", error);
                alert("åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
            } finally {
                submitSpinner.classList.add('hidden');
                submitBtnText.classList.remove('hidden');
            }
        });
        
        function showPostDetail(post) {
            const liked = isPostLiked(post.id);
            detailContent.innerHTML = `
                <div class="w-full max-w-4xl h-full lg:h-auto lg:max-h-[90vh] bg-white flex flex-col lg:flex-row rounded-none lg:rounded-2xl overflow-hidden shadow-2xl">
                    <div class="w-full lg:w-1/2 bg-gray-100 flex items-center justify-center">
                         <img src="${post.imageUrl}" alt="${post.title}" class="w-auto h-auto max-w-full max-h-full object-contain">
                    </div>
                    <div class="w-full lg:w-1/2 p-6 flex flex-col">
                        <div class="flex items-center gap-3 mb-4">
                             <div>
                                 <p class="font-bold text-gray-800">${post.author.displayName}</p>
                                 <p class="text-xs text-gray-500">${post.createdAt ? post.createdAt.toDate().toLocaleDateString() : 'åˆšåˆš'}</p>
                             </div>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900 mb-2">${post.title}</h2>
                        <div class="text-gray-600 text-sm leading-relaxed overflow-y-auto flex-1 mb-4">
                            <p>${post.content.replace(/\n/g, '<br>')}</p>
                        </div>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${post.tags ? post.tags.map(tag => `<span class="tag text-xs px-2 py-1 rounded">#${tag}</span>`).join('') : ''}
                        </div>
                        <div class="mt-auto border-t border-gray-200 pt-4 flex items-center justify-between">
                            <div class="flex items-center gap-4 text-xl text-gray-500">
                                <button data-id="${post.id}" class="like-btn ${liked ? 'liked' : ''} transition-transform transform hover:scale-110">
                                    <i class="fas fa-heart"></i>
                                    <span class="like-count text-sm ml-1">${post.likes || 0}</span>
                                </button>
                                <button data-post-info='${JSON.stringify({title: post.title, content: post.content}).replace(/'/g, "&apos;")}' class="ai-comment-btn transition-transform transform hover:scale-110">
                                    <i class="fas fa-magic-sparkles"></i>
                                </button>
                                <button><i class="far fa-bookmark"></i></button>
                            </div>
                            <button class="text-xl text-gray-500"><i class="fas fa-share-alt"></i></button>
                        </div>
                         <div id="ai-comment-area" class="mt-4 hidden">
                            <p class="text-sm font-bold text-gray-700 mb-2">AI è¯„è®ºå»ºè®®:</p>
                            <div class="bg-gray-100 p-3 rounded-lg text-sm text-gray-600"></div>
                         </div>
                    </div>
                </div>
            `;
            detailModal.classList.remove('hidden');
            detailModal.classList.add('flex');
            detailModal.querySelector('.like-btn').addEventListener('click', (e) => { e.stopPropagation(); toggleLike(post.id); });
            detailModal.querySelector('.ai-comment-btn').addEventListener('click', handleAiCommentGeneration);
        }
        
        async function handleAiCommentGeneration(e) {
            const button = e.currentTarget;
            const postInfo = JSON.parse(button.dataset.postInfo.replace(/&apos;/g, "'"));
            const commentArea = detailModal.querySelector('#ai-comment-area');
            const commentContent = commentArea.querySelector('div');
            button.disabled = true;
            commentContent.textContent = "AI æ­£åœ¨æ€è€ƒä¸­...";
            commentArea.classList.remove('hidden');
            const prompt = `ä½ æ˜¯ä¸€ä½é£è¶£å¹½é»˜ã€å–„äºå‘ç°ç»†èŠ‚çš„ç½‘å‹ã€‚è¯·é’ˆå¯¹ä»¥ä¸‹å¸–å­çš„æ ‡é¢˜å’Œå†…å®¹ï¼Œå†™ä¸€æ¡å‹å–„ã€æœ‰è¶£ã€å…·ä½“çš„è¯„è®ºã€‚ä¸è¦ä½¿ç”¨æ¨¡æ¿åŒ–çš„è¯­è¨€ï¼Œè¦åƒæ˜¯çœŸäººä¼šè¯´çš„è¯ã€‚è¯„è®ºå†…å®¹è¦ç®€çŸ­ã€‚
            æ ‡é¢˜: "${postInfo.title}"
            å†…å®¹: "${postInfo.content}"`;
            const resultText = await callDeepSeekAPI(prompt);
            if(resultText) commentContent.textContent = resultText;
            button.disabled = false;
        }
        
        function closeDetailModal() {
            detailModal.classList.add('hidden');
            detailModal.classList.remove('flex');
            detailContent.innerHTML = '';
        }
        closeDetailModalBtn.addEventListener('click', closeDetailModal);
        detailModal.addEventListener('click', (e) => e.target === detailModal && closeDetailModal());
        
        async function toggleLike(postId) {
            if (postId.startsWith('mock')) {
                 alert("æ¼”ç¤ºå¸–å­æ— æ³•ç‚¹èµå“¦~");
                 return;
            }
            const postRef = doc(db, 'posts', postId);
            const likeBtn = detailModal.querySelector(`.like-btn[data-id="${postId}"]`);
            const likeCountEl = likeBtn.querySelector('.like-count');
            const wasLiked = isPostLiked(postId);
            const incrementValue = wasLiked ? -1 : 1;
            likeBtn.classList.toggle('liked', !wasLiked);
            likeCountEl.textContent = parseInt(likeCountEl.textContent) + incrementValue;
            toggleLocalLike(postId);
            try {
                await updateDoc(postRef, { likes: increment(incrementValue) });
            } catch (error) {
                console.error("Failed to update likes:", error);
                likeBtn.classList.toggle('liked', wasLiked);
                likeCountEl.textContent = parseInt(likeCountEl.textContent) - incrementValue;
                toggleLocalLike(postId);
                alert("ç‚¹èµå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
            }
        }
    </script>
    <!-- å³ä¸Šè§’è¿”å›æŒ‰é’® -->
    <button
      id="back-btn"
      class="fixed top-6 right-8 bg-white border border-gray-200 shadow-lg rounded-full px-5 py-2 text-blue-600 font-semibold hover:bg-blue-50 transition-all z-50 flex items-center gap-2"
      onclick="window.history.back()"
    >
      <i class="fas fa-arrow-left"></i>
      è¿”å›
    </button>
</body>
</html>

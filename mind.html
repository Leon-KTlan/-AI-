<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindGuard - æ™ºèƒ½ä¼™ä¼´ V2</title>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* åŸºæœ¬å­—ä½“å’ŒèƒŒæ™¯ */
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f0f2f5; /* æ›´ç°ä»£çš„æµ…ç°è‰²èƒŒæ™¯ */
            color: #1a202c; /* æ·±ç°è‰²æ–‡å­—ï¼Œå¯¹æ¯”æ›´æ¸…æ™° */
            overscroll-behavior-y: contain; /* é˜²æ­¢é¡µé¢æ»šåŠ¨ä¼ é€’åˆ°æµè§ˆå™¨å¯¼èˆª */
        }

        /* Bento Box åŸºç¡€æ ·å¼ */
        .bento-box {
            background-color: rgba(255, 255, 255, 0.85); /* è½»å¾®é€æ˜çš„ç™½è‰²èƒŒæ™¯ */
            backdrop-filter: blur(12px) saturate(150%); /* å¢åŠ é¥±å’Œåº¦ä½¿æ¯›ç»ç’ƒæ•ˆæœæ›´æ˜æ˜¾ */
            border-radius: 24px; /* æ›´åœ†æ¶¦çš„è¾¹è§’ */
            padding: clamp(1.5rem, 4vw, 2.5rem); /* å“åº”å¼å†…è¾¹è· */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05), 0 16px 32px rgba(0,0,0,0.05); /* æ›´æŸ”å’Œçš„é˜´å½± */
            transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(226, 232, 240, 0.5); /* ç»†å¾®è¾¹æ¡† */
        }

        .bento-box:hover {
            transform: translateY(-6px) scale(1.015);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.07), 0 24px 48px rgba(0,0,0,0.07);
        }

        /* è¶…å¤§ä¸­æ–‡æ ‡é¢˜ */
        .highlight-text-cn {
            font-size: clamp(2.25rem, 6vw, 4rem); /* å“åº”å¼è¶…å¤§å­—ä½“ */
            font-weight: 800; /* æ›´ç²—çš„å­—é‡ */
            color: #2c5282; /* æ·±è“ï¼Œæ›´æ²‰ç¨³ */
            line-height: 1.15;
            letter-spacing: -0.02em; /* è½»å¾®å­—è·è°ƒæ•´ */
        }

        /* ç‚¹ç¼€è‹±æ–‡å°å­— */
        .highlight-text-en {
            font-size: clamp(0.75rem, 1.8vw, 0.9rem);
            font-weight: 500;
            color: #718096; /* ä¸­ç°è‰² */
            text-transform: uppercase;
            letter-spacing: 0.075em;
            display: block;
            margin-top: 0.35rem;
        }
        
        /* ä¸»è¦æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background-image: linear-gradient(to right, #3b82f6 0%, #2563eb 50%, #3b82f6 100%);
            background-size: 200% auto;
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 18px -7px rgba(59, 130, 246, 0.6);
            border: none;
        }
        .btn-primary:hover {
            background-position: right center; /* æ¸å˜åŠ¨ç”» */
            transform: translateY(-3px);
            box-shadow: 0 7px 22px -7px rgba(59, 130, 246, 0.8);
        }

        /* æ¬¡è¦/ç‰¹è‰²æŒ‰é’® (ä¾‹å¦‚MBTIæŒ‰é’®) */
        .btn-special {
            background-image: linear-gradient(to right, #10b981 0%, #059669 50%, #10b981 100%);
            background-size: 200% auto;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 5px 18px -7px rgba(16, 185, 129, 0.5);
            border: none;
        }
        .btn-special:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 7px 22px -7px rgba(16, 185, 129, 0.7);
        }
        
        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .chat-messages {
            max-height: calc(100vh - 380px); /* åŠ¨æ€è®¡ç®—æœ€å¤§é«˜åº¦ */
            min-height: 300px; /* ä¿è¯æœ€å°é«˜åº¦ */
            overflow-y: auto;
            padding-right: 12px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
            scroll-behavior: smooth;
        }
        .message { padding: 14px 20px; border-radius: 22px; line-height: 1.55; font-size: 0.98rem; max-width: 85%; word-break: break-word; }
        .bot-message { background-color: #e0e7ff; /* æ·¡ç´«è‰²èƒŒæ™¯ */ color: #3730a3; border-bottom-left-radius: 6px; align-self: flex-start; }
        .user-message { background-color: #3b82f6; /* ä¸»é¢˜è“ */ color: white; border-bottom-right-radius: 6px; align-self: flex-end; }
        .message-time { font-size: 0.7rem; opacity: 0.65; margin-top: 6px; text-align: right; }
        .thinking-indicator .message-content { font-style: italic; color: #4a5568; }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ (Webkit) */
        .chat-messages::-webkit-scrollbar { width: 7px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            background: rgba(17, 24, 39, 0.6); /* æ›´æ·±çš„åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: #ffffff;
            padding: clamp(1.5rem, 5vw, 3rem);
            border-radius: 28px; /* æ›´å¤§çš„åœ†è§’ */
            width: 90%;
            max-width: 750px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .report-card {
            background: #f9fafb; /* éå¸¸æµ…çš„ç°è‰²å¡ç‰‡èƒŒæ™¯ */
            padding: 1.75rem;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
         .report-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.05);
        }
        .report-card h3 { color: #2563eb; margin-bottom: 1rem; font-size: 1.3rem; font-weight: 700; }
        .report-card p { color: #374151; line-height: 1.65; font-size: 0.95rem; }
        .hospital-link { color: #2563eb; font-weight: 600; }

        /* ç§‘æŠ€æ„Ÿé«˜äº®è¾¹æ¡†/èƒŒæ™¯ (å¯é€‰) */
        .tech-glow {
            position: relative;
        }
        .tech-glow::before, .tech-glow::after {
            content: '';
            position: absolute;
            left: -2px; top: -2px;
            background: linear-gradient(45deg, #3b82f6, #10b981, #ef4444, #8b5cf6, #3b82f6);
            background-size: 400%;
            width: calc(100% + 4px);
            height: calc(100% + 4px);
            z-index: -1;
            animation: techGlowAnimation 20s linear infinite;
            border-radius: inherit; /* ç»§æ‰¿çˆ¶å…ƒç´ çš„åœ†è§’ */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .bento-box:hover .tech-glow::before { opacity: 0.3; } /* æ‚¬åœæ—¶æ˜¾ç¤ºè¾‰å…‰ */
        @keyframes techGlowAnimation { 0% { background-position: 0 0; } 50% { background-position: 400% 0; } 100% { background-position: 0 0; } }
        
        /* è¾“å…¥åŒºåŸŸæ ·å¼ */
        .chat-input-area {
            border-top: 1px solid #e5e7eb;
            padding-top: 1.25rem;
            background-color: rgba(255, 255, 255, 0.7); /* è½»å¾®é€æ˜ */
            backdrop-filter: blur(8px);
            border-bottom-left-radius: 24px; /* åŒ¹é…çˆ¶å®¹å™¨åœ†è§’ */
            border-bottom-right-radius: 24px;
        }
        .chat-input-area textarea {
            border-radius: 16px;
            padding: 0.85rem 1.15rem;
            min-height: 58px; /* å›ºå®šåˆå§‹é«˜åº¦ */
            max-height: 180px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
        }
        .chat-input-area textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3.5px rgba(59, 130, 246, 0.25);
            background-color: white;
        }
        .chat-input-area button {
            min-width: 58px; height: 58px; border-radius: 16px; /* ç»Ÿä¸€å°ºå¯¸ */
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }
        .chat-input-area .btn-special { font-size: 0.9rem; padding-left: 1.2rem; padding-right: 1.2rem; }

        /* ä½¿Framer MotionåŠ¨ç”»æ›´å¹³æ»‘ */
        [data-motion] { will-change: transform, opacity; }

        /* MBTIè¿›åº¦æ¡æ ·å¼ */
        .mbti-progress-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 1rem auto; /* æ°´å¹³å±…ä¸­ï¼Œåº•éƒ¨ç•™å‡ºé—´è· */
            background: #e0e6ed;
            border-radius: 8px;
            height: 22px;
            box-shadow: 0 1px 4px rgba(60,123,190,0.05);
            display: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .mbti-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            border-radius: 8px;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            color: #fff;
            font-weight: bold;
            font-size: 0.95em;
            padding-right: 10px;
            box-sizing: border-box;
        }
        .mbti-progress-text {
            position: absolute;
            width: 100%;
            left: 0;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2563eb;
            font-weight: bold;
            font-size: 0.95em;
            pointer-events: none;
        }
        
        /* MBTIæŠ¥å‘Šå¡ç‰‡æ ·å¼ */
        .mbti-report-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .mbti-report-card h4 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #16a34a;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }
        .mbti-report-card h4 i {
            margin-right: 0.75rem;
        }
        .mbti-report-card p, .mbti-report-card ul {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #475569;
        }
        .mbti-report-card ul {
            list-style-position: inside;
            padding-left: 0.5rem;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-3 md:p-6 selection:bg-blue-500 selection:text-white" style="margin-top: 12vh;">

    <button id="backBtn" class="absolute right-4 top-4 z-10 text-gray-400 hover:text-blue-600 transition-colors duration-200 text-2xl flex items-center opacity-0 pointer-events-none" title="è¿”å›">
        <span class="mr-1 text-base font-medium hidden md:inline">è¿”å›</span>
        <i class="fas fa-arrow-right"></i>
    </button>
    <div id="app-container" class="w-full max-w-7xl mx-auto relative">


        <header class="py-10 md:py-16 text-center" data-motion data-initial='{ "opacity": 0, "y": -30 }' data-animate='{ "opacity": 1, "y": 0 }' data-transition='{ "duration": 0.6, "ease": "easeOut" }'>
            <h1 class="text-5xl md:text-7xl font-extrabold text-gray-800 tracking-tight">
                Mind<span class="text-blue-600">Guard</span>
                <span class="block text-xl md:text-2xl font-medium text-gray-500 mt-3">æ™ºèƒ½ä¼™ä¼´ <span class="font-sans text-gray-400">|</span> Your AI Companion</span>
            </h1>
            <p class="mt-5 text-gray-600 max-w-2xl mx-auto text-base md:text-lg leading-relaxed">
                éšæ—¶å€¾å¬ï¼Œç»™äºˆæ”¯æŒä¸æ´å¯Ÿã€‚æ¢ç´¢è‡ªæˆ‘ï¼Œä¸ MindGuard ä¸€åŒæˆé•¿ã€‚
                <span class="block text-xs text-gray-400 mt-2">Always listening, offering support and insights. Explore yourself and grow with MindGuard.</span>
            </p>
            <button id="startExperience" class="mt-8 btn-primary text-lg px-8 py-3">
                å¼€å§‹ä½“éªŒ <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-5 md:gap-7 opacity-0 h-0 overflow-hidden transition-all duration-700 ease-out" id="mainContent">
            <div class="bento-box lg:col-span-2 min-h-[650px] flex flex-col tech-glow relative" data-motion data-initial='{ "opacity": 0, "y": 40 }' data-animate='{ "opacity": 1, "y": 0 }' data-transition='{ "duration": 0.6, "delay": 0.15, "ease": "easeOut" }'>

                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-700">
                        ç–—æ„ˆå¯¹è¯ <span class="text-sm font-light text-gray-500 ml-1.5 align-middle">HEALING CHAT</span>
                    </h2>
                    <i class="fas fa-comments text-blue-500 text-3xl opacity-80"></i>
                </div>
                <div class="chat-messages flex-1 space-y-4 mb-5 pr-1" id="chatMessages">
                    <div class="mbti-progress-container" id="mbti-progress-container">
                        <div class="mbti-progress-bar" id="mbti-progress-bar"></div>
                        <div class="mbti-progress-text" id="mbti-progress-text">0%</div>
                    </div>
                    <div class="message bot-message">
                        <div class="message-content">æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„AIç–—æ„ˆåŠ©æ‰‹ MindGuardã€‚æœ‰ä»€ä¹ˆæƒ³å’Œæˆ‘åˆ†äº«æˆ–è€…éœ€è¦å¸®åŠ©çš„å—ï¼Ÿå¾ˆé«˜å…´èƒ½ä¸æ‚¨äº¤æµã€‚</div>
                        <div class="message-time"></div> </div>
                </div>
                <div class="chat-input-area mt-auto flex items-end gap-3">
                    <textarea id="userInput" class="flex-1 resize-none" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„æƒ³æ³•æˆ–æ„Ÿå—..." rows="1"></textarea>
                    <button class="btn-primary" id="sendButton" title="å‘é€æ¶ˆæ¯">
                        <i class="fas fa-paper-plane text-xl"></i>
                    </button>
                    <button class="btn-special" id="mbtiButton" title="å¼€å§‹MBTIæ€§æ ¼æ¢ç´¢">
                        <i class="fas fa-brain mr-2 opacity-90"></i> MBTIæ¢ç´¢
                    </button>
                </div>
            </div>

            <div class="space-y-5 md:space-y-7 lg:col-span-1">
                <div class="bento-box tech-glow" data-motion data-initial='{ "opacity": 0, "x": 40 }' data-animate='{ "opacity": 1, "x": 0 }' data-transition='{ "duration": 0.6, "delay": 0.3, "ease": "easeOut" }'>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">
                            ä¸ªæ€§æ´å¯Ÿ <span class="text-xs font-light text-gray-500 ml-1 align-middle">PERSONALITY</span>
                        </h2>
                        <i class="fas fa-user-astronaut text-green-500 text-3xl opacity-80"></i>
                    </div>
                    <div id="mbtiResultArea" class="text-center py-5">
                        <p class="text-gray-500 text-sm mb-2">å®Œæˆå¯¹è¯æ¢ç´¢åï¼Œæ‚¨çš„MBTIå€¾å‘å°†æ˜¾ç¤ºåœ¨æ­¤ã€‚</p>
                        <span class="highlight-text-cn text-green-600" id="mbti-type-display">----</span>
                        <span class="highlight-text-en text-green-500" id="mbti-type-label-en">YOUR TYPE</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-5">åŸºäºæ‚¨çš„æ€§æ ¼ç‰¹è´¨ï¼Œä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†çš„MBTIä¸ªæ€§åˆ†ææŠ¥å‘Šã€‚</p>
                    <button id="mbtiReportBtn" class="w-full btn-primary bg-green-600 hover:bg-green-700 shadow-green-400/40 hover:shadow-green-500/60">
                        <i class="fas fa-user-chart mr-2"></i> ç”Ÿæˆä¸ªæ€§åˆ†æ
                    </button>
                    <p class="text-xs text-gray-400 mt-4 text-center">
                        *MBTIç»“æœç”±AIåˆ†æå¯¹è¯ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚
                    </p>
                </div>

                <div class="bento-box" data-motion data-initial='{ "opacity": 0, "x": 40 }' data-animate='{ "opacity": 1, "x": 0 }' data-transition='{ "duration": 0.6, "delay": 0.45, "ease": "easeOut" }'>
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">
                            å’¨è¯¢æŠ¥å‘Š <span class="text-xs font-light text-gray-500 ml-1 align-middle">AI REPORT</span>
                        </h2>
                        <i class="fas fa-file-medical-alt text-purple-500 text-3xl opacity-80"></i>
                    </div>
                    <p class="text-gray-600 text-sm mb-5">æ ¹æ®æ‚¨çš„å¯¹è¯å†…å®¹ï¼Œä¸ºæ‚¨ç”Ÿæˆä¸€ä»½ç®€è¦çš„AIåˆ†ææŠ¥å‘Šã€‚</p>
                    <button id="reportBtn" class="w-full btn-primary bg-purple-600 hover:bg-purple-700 shadow-purple-400/40 hover:shadow-purple-500/60">
                        <i class="fas fa-chart-line mr-2"></i> ç”Ÿæˆåˆ†ææŠ¥å‘Š
                    </button>
                     <p class="text-xs text-gray-400 mt-4 text-center">
                        *æŠ¥å‘Šç”±AIç”Ÿæˆï¼Œéä¸“ä¸šè¯Šæ–­ï¼Œä»…ä¾›å‚è€ƒã€‚
                    </p>
                </div>
            </div>
        </main>

        <!-- æ–°å¢åŠŸèƒ½åŒºåŸŸ -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-5 md:gap-7 mt-8 opacity-0 h-0 overflow-hidden transition-all duration-700 ease-out" id="extraContent">
            <div class="bento-box tech-glow" data-motion data-initial='{ "opacity": 0, "y": 40 }' data-animate='{ "opacity": 1, "y": 0 }' data-transition='{ "duration": 0.6, "delay": 0.2, "ease": "easeOut" }'>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">
                        è§£å‹æ¸¸æˆ <span class="text-xs font-light text-gray-500 ml-1 align-middle">RELAXING GAMES</span>
                    </h2>
                    <i class="fas fa-gamepad text-orange-500 text-3xl opacity-80"></i>
                </div>
                <p class="text-gray-600 text-sm mb-5">é€šè¿‡è½»æ¾æœ‰è¶£çš„å°æ¸¸æˆå¸®åŠ©æ‚¨æ”¾æ¾å¿ƒæƒ…ï¼Œç¼“è§£å‹åŠ›ï¼Œæ‰¾å›å†…å¿ƒçš„å¹³é™ä¸å¿«ä¹ã€‚</p>
                <div class="mb-5">
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-xs">è§£å‹ç›Šæ™º</span>
                        <span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-xs">æ”¾æ¾å†¥æƒ³</span>
                        <span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-xs">è¶£å‘³äº’åŠ¨</span>
                    </div>
                </div>
                <button id="gameBtn" class="w-full btn-primary bg-orange-500 hover:bg-orange-600 shadow-orange-400/40 hover:shadow-orange-500/60">
                    <i class="fas fa-play mr-2"></i> å¼€å§‹æ¸¸æˆ
                </button>
                <p class="text-xs text-gray-400 mt-4 text-center">
                    *è½»æ¾æ¸¸æˆï¼Œæ„‰æ‚¦èº«å¿ƒï¼Œäº«å—å½“ä¸‹çš„ç¾å¥½æ—¶å…‰ã€‚
                </p>
            </div>

            <div class="bento-box tech-glow" data-motion data-initial='{ "opacity": 0, "y": 40 }' data-animate='{ "opacity": 1, "y": 0 }' data-transition='{ "duration": 0.6, "delay": 0.4, "ease": "easeOut" }'>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">
                        å¿ƒç†ç¤¾åŒº <span class="text-xs font-light text-gray-500 ml-1 align-middle">COMMUNITY</span>
                    </h2>
                    <i class="fas fa-users text-pink-500 text-3xl opacity-80"></i>
                </div>
                <p class="text-gray-600 text-sm mb-5">ä¸å¿—åŒé“åˆçš„æœ‹å‹åˆ†äº«å¿ƒæƒ…ï¼Œè®°å½•æˆé•¿è¶³è¿¹ï¼Œåœ¨è¿™ä¸ªæ¸©æš–çš„ç¤¾åŒºä¸­äº’ç›¸æ”¯æŒã€‚</p>
                <div class="mb-5">
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="bg-pink-100 text-pink-600 px-2 py-1 rounded-full text-xs">å¿ƒæƒ…åˆ†äº«</span>
                        <span class="bg-pink-100 text-pink-600 px-2 py-1 rounded-full text-xs">æˆé•¿è®°å½•</span>
                        <span class="bg-pink-100 text-pink-600 px-2 py-1 rounded-full text-xs">äº’åŠ©äº¤æµ</span>
                    </div>
                </div>
                <button id="noteBtn" class="w-full btn-primary bg-pink-500 hover:bg-pink-600 shadow-pink-400/40 hover:shadow-pink-500/60">
                    <i class="fas fa-heart mr-2"></i> è¿›å…¥ç¤¾åŒº
                </button>
                <p class="text-xs text-gray-400 mt-4 text-center">
                    *æ¸©æš–é™ªä¼´ï¼Œå…±åŒæˆé•¿ï¼Œæ¯ä¸€ä»½åˆ†äº«éƒ½å€¼å¾—çæƒœã€‚
                </p>
            </div>
        </section>

        <footer class="text-center py-10 md:py-16 mt-8 border-t border-gray-200/80 transition-all duration-500 ease-out" id="initialFooter" data-motion data-initial='{ "opacity": 0 }' data-animate='{ "opacity": 1 }' data-transition='{ "duration": 0.5, "delay": 0.6, "ease": "easeOut" }'>
            <p class="text-sm text-gray-500">MindGuard &copy; <span id="currentYear"></span> | æ™ºèƒ½å¯¹è¯ä¼™ä¼´</p>
            <p class="text-xs text-gray-400 mt-2 leading-relaxed max-w-md mx-auto">
                æ³¨æ„ï¼šæœ¬åº”ç”¨æä¾›çš„AIå¯¹è¯ä¸åˆ†æä¸æ„æˆä¸“ä¸šå¿ƒç†å’¨è¯¢æˆ–æ²»ç–—å»ºè®®ã€‚å¦‚æœ‰ä¸¥é‡å¿ƒç†å¥åº·å›°æ‰°ï¼Œè¯·åŠ¡å¿…å¯»æ±‚ä¸“ä¸šäººå£«å¸®åŠ©ã€‚
            </p>
             <p class="text-xs text-gray-400 mt-1">
                Disclaimer: This is not professional psychotherapy. For serious mental health issues, please consult a professional.
            </p>
        </footer>
    </div>

    <!-- æŠ¥å‘Šæ¨¡æ€æ¡† -->
    <div id="reportModal" class="modal fixed inset-0 z-[100] hidden items-center justify-center p-4 transition-opacity duration-300 ease-out opacity-0">
        <div class="modal-content overflow-y-auto max-h-[90vh] w-full transition-transform duration-300 ease-out scale-95" data-motion-modal-content>
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                <div>
                    <h2 class="text-3xl font-bold text-blue-600">
                        AIåˆ†ææŠ¥å‘Š <span class="text-base font-normal text-gray-500 align-middle">Analysis</span>
                    </h2>
                    <div id="mbti-type-in-report" class="mt-2 text-lg font-semibold text-green-600"></div>
                </div>
                <div class="flex gap-2">
                    <button id="copyReportBtn" class="text-gray-400 hover:text-blue-600 text-2xl transition-colors" title="å¤åˆ¶æŠ¥å‘Š"><i class="fas fa-copy"></i></button>
                    <button id="exportReportBtn" class="text-gray-400 hover:text-green-600 text-2xl transition-colors" title="å¯¼å‡ºä¸ºTXT"><i class="fas fa-file-arrow-down"></i></button>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-4xl leading-none -mt-2 transition-colors">&times;</button>
                </div>
            </div>
            <div class="report-grid grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                <div class="report-card">
                    <h3 class="flex items-center"><i class="fas fa-user-circle mr-3 text-xl text-blue-500"></i>ç”¨æˆ·ç”»åƒ <span class="text-xs font-light ml-1">PROFILE</span></h3>
                    <p id="report-user-profile" class="mt-2">æŠ¥å‘Šç”Ÿæˆä¸­...</p>
                </div>
                <div class="report-card">
                    <h3 class="flex items-center"><i class="fas fa-heart-pulse mr-3 text-xl text-red-500"></i>å¿ƒç†çŠ¶æ€è¯„ä¼° <span class="text-xs font-light ml-1">MENTAL STATE</span></h3>
                    <p id="report-mental-state" class="mt-2">æŠ¥å‘Šç”Ÿæˆä¸­...</p>
                </div>
                <div class="report-card">
                    <h3 class="flex items-center"><i class="fas fa-grin-beam mr-3 text-xl text-yellow-500"></i>æƒ…æ„Ÿåˆ†æ <span class="text-xs font-light ml-1">EMOTIONS</span></h3>
                    <p id="report-emotion-analysis" class="mt-2">æŠ¥å‘Šç”Ÿæˆä¸­...</p>
                </div>
                <div class="report-card">
                    <h3 class="flex items-center"><i class="fas fa-lightbulb-on mr-3 text-xl text-green-500"></i>AIå»ºè®® <span class="text-xs font-light ml-1">SUGGESTIONS</span></h3>
                    <p id="report-suggestions" class="mt-2">æŠ¥å‘Šç”Ÿæˆä¸­...</p>
                    <a href="https://www.xinli001.com/" target="_blank" class="hospital-link block mt-4 hover:underline">
                       <i class="fas fa-external-link-alt mr-1.5"></i> è®¿é—®å£¹å¿ƒç†è·å–ä¸“ä¸šå¸®åŠ©
                    </a>
                </div>
            </div>
             <p class="text-xs text-gray-500 mt-8 text-center">
                *æœ¬æŠ¥å‘Šç”±AIæ ¹æ®å¯¹è¯è®°å½•åˆ†æç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­ã€‚
            </p>
        </div>
    </div>

    <!-- MBTIæ¨¡å¼é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="mbtiModeModal" class="modal fixed inset-0 z-[110] hidden items-center justify-center p-4 transition-opacity duration-300 ease-out opacity-0">
        <div class="modal-content overflow-y-auto max-h-[90vh] w-full transition-transform duration-300 ease-out scale-95" style="max-width: 420px;" data-motion-modal-content>
            <div class="flex flex-col items-center">
                <h2 class="text-2xl font-bold text-blue-600 mb-4">é€‰æ‹©MBTIæ¢ç´¢æ¨¡å¼</h2>
                <div class="flex gap-4 mb-6">
                    <button id="mbtiTextModeBtn" class="btn-special text-lg px-6 py-2">æ–‡å­—æ¨¡å¼</button>
                    <button id="mbtiChatModeBtn" class="btn-primary text-lg px-6 py-2">å¯¹è¯æ¨¡å¼</button>
                </div>
                <div id="mbtiTextModeContent" class="w-full text-center hidden">
                    <div class="bento-box">
                        <p class="text-gray-500 text-lg mb-2">æ–‡å­—æ¨¡å¼åŠŸèƒ½æ•¬è¯·æœŸå¾… ğŸ˜Š</p>
                        <p class="text-sm text-gray-400">æˆ‘ä»¬æ­£åœ¨åŠªåŠ›å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>
                    </div>
                </div>
            </div>
            <button id="closeMbtiModeModal" class="absolute top-4 right-6 text-gray-400 hover:text-gray-600 text-3xl leading-none transition-colors">&times;</button>
        </div>
    </div>

    <!-- MBTIä¸ªæ€§åˆ†ææŠ¥å‘Šå¼¹çª— -->
    <div id="mbtiReportModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50 opacity-0">
        <div data-motion-modal-content class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden transform scale-95">
            <div class="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-user-chart text-green-600 mr-2"></i>
                    ä¸ªæ€§æ·±åº¦åˆ†ææŠ¥å‘Š
                </h2>
                <button id="closeMbtiReportModal" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-gray-600"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <div id="mbtiReportContent">
                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div id="mbtiReportLoading" class="text-center py-12">
                        <div class="inline-block w-12 h-12 border-4 border-green-200 border-t-green-600 rounded-full animate-spin mb-4"></div>
                        <p class="text-gray-600 font-medium">AI æ­£åœ¨æ·±åº¦åˆ†ææ‚¨çš„æ€§æ ¼ç‰¹å¾ï¼Œè¯·ç¨å€™...</p>
                    </div>
                    <!-- æŠ¥å‘Šå†…å®¹ -->
                    <div id="mbtiFullReport" class="hidden">
                        <div class="text-center mb-8">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">æ‚¨çš„æ€§æ ¼ç±»å‹ï¼š</h3>
                            <p id="mbtiReportType" class="text-5xl font-extrabold text-green-600 mb-1">----</p>
                            <p id="mbtiReportName" class="text-lg font-semibold text-gray-500 mb-4"></p>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p id="mbtiReportDescription" class="text-gray-700 leading-relaxed">åˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
                            </div>
                        </div>
                        <div id="mbtiDetailedReport" class="space-y-4">
                            <!-- è¯¦ç»†æŠ¥å‘Šå†…å®¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </div>
                        <div class="flex gap-3 mt-6 pt-4 border-t border-gray-100">
                            <button id="copyMbtiReportBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-copy mr-2"></i>å¤åˆ¶æŠ¥å‘Š
                            </button>
                            <button id="exportMbtiReportBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-download mr-2"></i>å¯¼å‡ºæŠ¥å‘Š
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Framer Motion related variables ---
        let fm; 
        let AnimatePresence;

        function applyMotionAnimations() {
            if (!fm || typeof fm.animate !== 'function') {
                console.error("Framer Motion 'fm.animate' is not initialized or not a function.");
                document.querySelectorAll('[data-motion]').forEach(el => {
                    el.style.opacity = 1;
                    el.style.transform = 'none';
                });
                return;
            }
            document.querySelectorAll('[data-motion]').forEach(el => {
                try {
                    const initial = el.dataset.initial ? JSON.parse(el.dataset.initial.replace(/'/g, '"')) : { opacity: 0 };
                    const animate = el.dataset.animate ? JSON.parse(el.dataset.animate.replace(/'/g, '"')) : { opacity: 1 };
                    const transition = el.dataset.transition ? JSON.parse(el.dataset.transition.replace(/'/g, '"')) : { duration: 0.5 };
                    Object.keys(initial).forEach(key => {
                        if (key === 'opacity') {
                            el.style.opacity = initial[key];
                        } else {
                            const value = initial[key];
                            const unit = (typeof value === 'number' && (key === 'y' || key === 'x')) ? 'px' : '';
                            el.style.transform = `${el.style.transform || ''} ${key}(${value}${unit})`;
                        }
                    });
                    setTimeout(() => { fm.animate(el, animate, transition); }, 50);
                } catch (e) {
                    console.error("Failed to parse motion attributes for element or apply animation:", el, e);
                    el.style.opacity = 0;
                    setTimeout(() => {
                        el.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                        el.style.opacity = 1;
                        el.style.transform = 'none';
                    }, 50);
                }
            });
        }
        
        // --- Constants and Configuration ---
        const DEEPSEEK_API_KEY = 'DeepSeekAPI'; 
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';
        
        // MBTIç±»å‹æ•°æ®
        const MBTI_TYPES = {
            'INTJ': { name: 'å»ºç­‘å¸ˆ' }, 'INTP': { name: 'é€»è¾‘å­¦å®¶' },
            'ENTJ': { name: 'æŒ‡æŒ¥å®˜' }, 'ENTP': { name: 'è¾©è®ºå®¶' },
            'INFJ': { name: 'æå€¡è€…' }, 'INFP': { name: 'è°ƒåœè€…' },
            'ENFJ': { name: 'ä¸»äººå…¬' }, 'ENFP': { name: 'ç«é€‰è€…' },
            'ISTJ': { name: 'ç‰©æµå¸ˆ' }, 'ISFJ': { name: 'å®ˆå«è€…' },
            'ESTJ': { name: 'æ€»ç»ç†' }, 'ESFJ': { name: 'æ‰§æ”¿å®˜' },
            'ISTP': { name: 'é‰´èµå®¶' }, 'ISFP': { name: 'æ¢é™©å®¶' },
            'ESTP': { name: 'ä¼ä¸šå®¶' }, 'ESFP': { name: 'è¡¨æ¼”è€…' }
        };
        const mbtiScenariosData = [ { "id": "social_and_energy_scenario_1", "name": "ç¤¾äº¤ä¸ç²¾åŠ›æƒ…æ™¯", "description": "è¿™ç»„é—®é¢˜æ—¨åœ¨äº†è§£æ‚¨åœ¨ç¤¾äº¤äº’åŠ¨ä¸­å¦‚ä½•è·å–å’Œæ¶ˆè€—ç²¾åŠ›ã€‚", "questions": [ { "q_id": "se_q1", "text": "æƒ³è±¡ä¸€ä¸‹ï¼Œä¸€ä¸ªå¿™ç¢Œçš„å·¥ä½œå‘¨ç»“æŸåï¼Œæ‚¨æ„Ÿåˆ°æœ‰äº›ç–²æƒ«ã€‚æ‚¨æ˜¯æ›´å€¾å‘äºå‚åŠ ä¸€ä¸ªæœ‹å‹çš„èšä¼šï¼Œé€šè¿‡å’Œå¤§å®¶äº¤æµæ¥æ”¾æ¾å’Œæ¢å¤ç²¾åŠ›ï¼Œè¿˜æ˜¯æ›´å–œæ¬¢ç‹¬è‡ªåœ¨å®¶ï¼Œå®‰é™åœ°åšè‡ªå·±å–œæ¬¢çš„äº‹æƒ…æ¥å……ç”µï¼Ÿè¯·åˆ†äº«æ‚¨çš„é€‰æ‹©å’ŒåŸå› ã€‚", "mbti_aspect": "E_vs_I" }, { "q_id": "se_q2", "text": "å½“æ‚¨éœ€è¦è§£å†³ä¸€ä¸ªå¤æ‚é—®é¢˜æ—¶ï¼Œæ‚¨æ˜¯æ›´å–œæ¬¢å’Œå›¢é˜Ÿæˆå‘˜ä¸€èµ·è®¨è®ºã€å¤´è„‘é£æš´ï¼Œä»ä¸åŒçš„è§‚ç‚¹ä¸­è·å¾—å¯å‘ï¼Œè¿˜æ˜¯æ›´å€¾å‘äºè‡ªå·±ç‹¬ç«‹æ€è€ƒï¼Œæ·±å…¥é’»ç ”ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ", "mbti_aspect": "E_vs_I, T_vs_F" }, { "q_id": "se_q3", "text": "åœ¨å’Œä¸å¤ªç†Ÿæ‚‰çš„äººäº¤æµæ—¶ï¼Œæ‚¨é€šå¸¸æ˜¯èƒ½å¾ˆå¿«æ‰¾åˆ°è¯é¢˜å¹¶ä¸»åŠ¨å¼€å¯å¯¹è¯ï¼Œè¿˜æ˜¯æ›´å–œæ¬¢å…ˆå¬å¯¹æ–¹è¯´ï¼Œæ…¢æ…¢åŠ å…¥è®¨è®ºï¼Ÿ", "mbti_aspect": "E_vs_I" }, { "q_id": "se_q4", "text": "å¦‚æœæœ‰ä¸€ä¸ªæœºä¼šå»ä¸€ä¸ªå…¨æ–°çš„ç¯å¢ƒï¼Œè®¤è¯†ä¸€ç¾¤æ–°æœ‹å‹ï¼Œæ‚¨ä¼šæ„Ÿåˆ°å…´å¥‹å’ŒæœŸå¾…ï¼Œè¿˜æ˜¯ä¼šæœ‰äº›çŠ¹è±«å’Œä¸å®‰ï¼Ÿ", "mbti_aspect": "E_vs_I, J_vs_P" } ] }, { "id": "information_gathering_scenario_2", "name": "ä¿¡æ¯æ”¶é›†æƒ…æ™¯", "description": "è¿™ç»„é—®é¢˜å…³æ³¨æ‚¨å¦‚ä½•æ„ŸçŸ¥å’Œå¤„ç†ä¿¡æ¯ã€‚", "questions": [ { "q_id": "ig_q1", "text": "å½“æ‚¨æ¥è§¦åˆ°ä¸€ä¸ªå…¨æ–°çš„äº‹ç‰©æˆ–æ¦‚å¿µæ—¶ï¼Œæ‚¨æ˜¯æ›´å€¾å‘äºå…³æ³¨å®ƒçš„å…·ä½“ç»†èŠ‚ã€å®é™…ç”¨é€”å’Œç°çŠ¶ï¼Œè¿˜æ˜¯æ›´å–œæ¬¢å»ç†è§£å®ƒçš„æ•´ä½“è§„å¾‹ã€å‘å±•è¶‹åŠ¿å’Œæ½œåœ¨æ„ä¹‰ï¼Ÿè¯·ä¸¾ä¾‹è¯´æ˜ã€‚", "mbti_aspect": "S_vs_N" }, { "q_id": "ig_q2", "text": "åœ¨é˜…è¯»ä¸€ä»½æŠ¥å‘Šæˆ–æ–‡ç« æ—¶ï¼Œæ‚¨æ˜¯æ›´å®¹æ˜“æ³¨æ„åˆ°å…¶ä¸­çš„äº‹å®ã€æ•°æ®å’Œå…·ä½“çš„ä¾‹å­ï¼Œè¿˜æ˜¯æ›´å®¹æ˜“çœ‹åˆ°ä½œè€…çš„è§‚ç‚¹ã€æ–‡ç« çš„ç»“æ„å’Œæ½œåœ¨çš„å«ä¹‰ï¼Ÿ", "mbti_aspect": "S_vs_N" }, { "q_id": "ig_q3", "text": "è°ˆåˆ°æœªæ¥ï¼Œæ‚¨æ˜¯æ›´å€¾å‘äºåŸºäºå½“å‰å·²æœ‰çš„ä¿¡æ¯å’Œç»éªŒæ¥é¢„æµ‹å’Œè§„åˆ’ï¼Œè¿˜æ˜¯æ›´å–œæ¬¢ç•…æƒ³å„ç§å¯èƒ½æ€§ï¼Œå³ä½¿å®ƒä»¬ç›®å‰çœ‹èµ·æ¥ä¸å¤ªç°å®ï¼Ÿ", "mbti_aspect": "S_vs_N" }, { "q_id": "ig_q4", "text": "æ‚¨åœ¨æè¿°ä¸€ä»¶äº‹æƒ…æ—¶ï¼Œæ˜¯æ›´å–œæ¬¢æŒ‰ç…§äº‹æƒ…å‘ç”Ÿçš„å…ˆåé¡ºåºï¼Œè¯¦ç»†æè¿°æ¯ä¸€ä¸ªç¯èŠ‚ï¼Œè¿˜æ˜¯æ›´å–œæ¬¢è·³è·ƒå¼åœ°è®²è¿°ï¼ŒæŠ“ä½é‡ç‚¹å’Œæ ¸å¿ƒæ€æƒ³ï¼Ÿ", "mbti_aspect": "S_vs_N, J_vs_P" } ] }, { "id": "decision_making_scenario_3", "name": "å†³ç­–ä¸åˆ¤æ–­æƒ…æ™¯", "description": "è¿™ç»„é—®é¢˜æ—¨åœ¨äº†è§£æ‚¨åœ¨åšå†³å®šå’Œè¯„ä»·äº‹ç‰©æ—¶æ›´çœ‹é‡ä»€ä¹ˆã€‚", "questions": [ { "q_id": "dm_q1", "text": "å½“æ‚¨éœ€è¦åšä¸€ä¸ªé‡è¦å†³å®šæ—¶ï¼Œæ‚¨æ˜¯æ›´å€¾å‘äºä¾èµ–é€»è¾‘åˆ†æã€æƒè¡¡åˆ©å¼Šã€è¿½æ±‚å®¢è§‚å’Œå…¬å¹³ï¼Œè¿˜æ˜¯æ›´å€¾å‘äºè€ƒè™‘è‡ªå·±çš„ä»·å€¼è§‚ã€å¯¹ä»–äººçš„å½±å“ä»¥åŠæ˜¯å¦ç¬¦åˆæ‚¨çš„æ„Ÿå—ï¼Ÿè¯·æè¿°ä¸€ä¸ªæ‚¨æœ€è¿‘åšé‡è¦å†³å®šçš„è¿‡ç¨‹ã€‚", "mbti_aspect": "T_vs_F" }, { "q_id": "dm_q2", "text": "åœ¨è¯„ä»·ä¸€ä¸ªè§‚ç‚¹æˆ–è¡Œä¸ºæ—¶ï¼Œæ‚¨æ˜¯æ›´å®¹æ˜“æŒ‡å‡ºå…¶é€»è¾‘ä¸Šçš„ä¸è¶³æˆ–äº‹å®é”™è¯¯ï¼Œè¿˜æ˜¯æ›´å®¹æ˜“å…³æ³¨å®ƒæ˜¯å¦åˆç†ã€æ˜¯å¦ç¬¦åˆæ‚¨çš„ä»·å€¼è§‚æˆ–æ˜¯å¦è€ƒè™‘äº†äººæƒ…ï¼Ÿ", "mbti_aspect": "T_vs_F" }, { "q_id": "dm_q3", "text": "å½“æ‚¨å’Œåˆ«äººæ„è§ä¸ä¸€è‡´æ—¶ï¼Œæ‚¨æ˜¯æ›´å€¾å‘äºç›´æ¥è¡¨è¾¾è‡ªå·±çš„è§‚ç‚¹ï¼Œé€šè¿‡è¾©è®ºæ¥è¯´æœå¯¹æ–¹ï¼Œè¿˜æ˜¯æ›´å€¾å‘äºå¯»æ‰¾å…±åŒç‚¹ï¼Œè¯•å›¾ç†è§£å¯¹æ–¹çš„æ„Ÿå—ï¼Œç»´æŠ¤å’Œè°çš„å…³ç³»ï¼Ÿ", "mbti_aspect": "T_vs_F, E_vs_I" }, { "q_id": "dm_q4", "text": "å¦‚æœæ‚¨çš„æœ‹å‹é‡åˆ°äº†ä¸€ä¸ªéš¾é¢˜ï¼Œå‘æ‚¨å¯»æ±‚å»ºè®®ã€‚æ‚¨æ˜¯æ›´å€¾å‘äºå¸®åŠ©ä»–ä»¬åˆ†æé—®é¢˜ã€æä¾›è§£å†³æ–¹æ¡ˆï¼Œè¿˜æ˜¯æ›´å€¾å‘äºå€¾å¬ä»–ä»¬çš„æ„Ÿå—ï¼Œç»™äºˆæƒ…æ„Ÿä¸Šçš„æ”¯æŒï¼Ÿ", "mbti_aspect": "T_vs_F" }, { "q_id": "dm_q5", "text": "åœ¨åšå†³å®šåï¼Œæ‚¨æ˜¯ä¼šæ„Ÿåˆ°äº‹æƒ…å°˜åŸƒè½å®šï¼Œå¯ä»¥ç»§ç»­å‰è¿›äº†ï¼Œè¿˜æ˜¯ä¼šç»§ç»­æ€è€ƒæ˜¯å¦æœ‰å…¶ä»–æ›´å¥½çš„é€‰æ‹©ï¼Ÿ", "mbti_aspect": "J_vs_P" } ] }, { "id": "lifestyle_and_planning_scenario_4", "name": "ç”Ÿæ´»æ–¹å¼ä¸è§„åˆ’æƒ…æ™¯", "description": "è¿™ç»„é—®é¢˜æ¢ç´¢æ‚¨åœ¨å¤„ç†æ—¥å¸¸äº‹åŠ¡å’Œåº”å¯¹å˜åŒ–æ—¶çš„åå¥½ã€‚", "questions": [ { "q_id": "lp_q1", "text": "åœ¨å¼€å§‹ä¸€ä¸ªé¡¹ç›®æˆ–ä»»åŠ¡æ—¶ï¼Œæ‚¨æ˜¯æ›´å–œæ¬¢å…ˆåˆ¶å®šä¸€ä¸ªè¯¦ç»†çš„è®¡åˆ’å’Œæ—¶é—´è¡¨ï¼Œç„¶åæŒ‰éƒ¨å°±ç­åœ°æ‰§è¡Œï¼Œè¿˜æ˜¯æ›´å–œæ¬¢å…ˆå¤§è‡´ç¡®å®šæ–¹å‘ï¼Œç„¶ååœ¨è¿‡ç¨‹ä¸­æ ¹æ®æƒ…å†µçµæ´»è°ƒæ•´ï¼Ÿ", "mbti_aspect": "J_vs_P" }, { "q_id": "lp_q2", "text": "æ‚¨å¯¹çªå‘æƒ…å†µæˆ–è®¡åˆ’å¤–çš„å˜åŒ–é€šå¸¸æŒä»€ä¹ˆæ€åº¦ï¼Ÿæ˜¯æ„Ÿåˆ°ä¸å®‰å’Œä¸é€‚ï¼Œè¿˜æ˜¯è§‰å¾—è¿™æ˜¯ä¸€ç§æŒ‘æˆ˜æˆ–æœºä¼šï¼Ÿ", "mbti_aspect": "J_vs_P" }, { "q_id": "lp_q3", "text": "åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæ‚¨æ˜¯æ›´å–œæ¬¢æŠŠäº‹æƒ…å®‰æ’å¾—äº•äº•æœ‰æ¡ï¼Œæå‰åšå¥½å‡†å¤‡ï¼Œè¿˜æ˜¯æ›´å–œæ¬¢ä¿æŒå¼¹æ€§ï¼Œæ ¹æ®å½“ä¸‹çš„å¿ƒæƒ…å’Œæƒ…å†µæ¥å†³å®šåšä»€ä¹ˆï¼Ÿ", "mbti_aspect": "J_vs_P" }, { "q_id": "lp_q4", "text": "å½“æ‚¨å®Œæˆä¸€ä¸ªé¡¹ç›®æˆ–ä»»åŠ¡æ—¶ï¼Œæ‚¨æ˜¯ä¼šæ„Ÿåˆ°å¾ˆæ»¡æ„ï¼Œå–œæ¬¢æŠŠäº‹æƒ…å½»åº•å®Œæˆå¹¶å‘Šä¸€æ®µè½ï¼Œè¿˜æ˜¯å³ä½¿å®Œæˆäº†ï¼Œä¹Ÿä¼šè§‰å¾—è¿˜æœ‰æ”¹è¿›çš„ç©ºé—´ï¼Œæˆ–è€…å¯¹æ–°çš„å¯èƒ½æ€§ä¿æŒå¼€æ”¾ï¼Ÿ", "mbti_aspect": "J_vs_P, S_vs_N" } ] }, { "id": "mixed_preference_scenario_5", "name": "æ··åˆåå¥½æƒ…æ™¯", "description": "è¿™ç»„é—®é¢˜ç»“åˆäº†ä¸åŒç»´åº¦ï¼Œæä¾›æ›´å…¨é¢çš„è§†è§’ã€‚", "questions": [ { "q_id": "mp_q1", "text": "å½“æ‚¨æ„Ÿåˆ°å‹åŠ›æ—¶ï¼Œæ‚¨æ˜¯æ›´å€¾å‘äºé€šè¿‡å’Œæœ‹å‹å€¾è¯‰ã€å¯»æ±‚å¤–éƒ¨æ”¯æŒæ¥ç¼“è§£ï¼Œè¿˜æ˜¯æ›´å€¾å‘äºè‡ªå·±ä¸€ä¸ªäººé™é™åœ°æ€è€ƒã€åˆ†æåŸå› å¹¶å¯»æ‰¾å†…åœ¨çš„è§£å†³æ–¹æ¡ˆï¼Ÿ", "mbti_aspect": "E_vs_I, T_vs_F" }, { "q_id": "mp_q2", "text": "åœ¨å­¦ä¹ æ–°æŠ€èƒ½æ—¶ï¼Œæ‚¨æ˜¯æ›´å–œæ¬¢é€šè¿‡å®è·µæ“ä½œã€æ‘¸ç´¢ç»éªŒæ¥æŒæ¡ï¼Œè¿˜æ˜¯æ›´å–œæ¬¢å…ˆç†è§£èƒŒåçš„åŸç†å’Œç†è®ºï¼Œç„¶åè¿›è¡Œç³»ç»Ÿå­¦ä¹ ï¼Ÿ", "mbti_aspect": "S_vs_N" }, { "q_id": "mp_q3", "text": "å¦‚æœæœ‰ä¸€ä¸ªæœºä¼šå‚ä¸ä¸€ä¸ªå…¨æ–°çš„ã€å……æ»¡ä¸ç¡®å®šæ€§çš„é¡¹ç›®ï¼Œæ‚¨ä¼šæ„Ÿåˆ°å…´å¥‹å¹¶è·ƒè·ƒæ¬²è¯•ï¼Œè¿˜æ˜¯ä¼šæ„Ÿåˆ°çŠ¹è±«ï¼Œæ›´å–œæ¬¢é€‰æ‹©é‚£äº›æœ‰æ˜ç¡®ç›®æ ‡å’Œè®¡åˆ’çš„é¡¹ç›®ï¼Ÿ", "mbti_aspect": "S_vs_N, J_vs_P" }, { "q_id": "mp_q4", "text": "æ‚¨è®¤ä¸ºè‡ªå·±åœ¨åšå†³å®šæ—¶ï¼Œæ˜¯æ›´åå‘äºå¿«é€Ÿåšå‡ºåˆ¤æ–­å¹¶æ‰§è¡Œï¼Œè¿˜æ˜¯æ›´åå‘äºèŠ±æ—¶é—´æ”¶é›†ä¿¡æ¯ã€è€ƒè™‘å„ç§å¯èƒ½æ€§åå†åšå†³å®šï¼Ÿ", "mbti_aspect": "J_vs_P, S_vs_N" }, { "q_id": "mp_q5", "text": "åœ¨ä¸ä»–äººåˆä½œæ—¶ï¼Œæ‚¨æ˜¯æ›´å€¾å‘äºå…³æ³¨ä»»åŠ¡çš„é€»è¾‘å’Œæ•ˆç‡ï¼Œç¡®ä¿æŒ‰æ—¶å®Œæˆï¼Œè¿˜æ˜¯æ›´å€¾å‘äºå…³æ³¨å›¢é˜Ÿæˆå‘˜çš„æ„Ÿå—å’Œåä½œæ°›å›´ï¼Œç¡®ä¿å¤§å®¶éƒ½èƒ½èˆ’é€‚åœ°å·¥ä½œï¼Ÿ", "mbti_aspect": "T_vs_F, E_vs_I" } ] } ];

        // --- State Variables ---
        let isMbtiTestActive = false;
        let currentMbtiQuestionIndex = 0;
        let mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
        let currentMbtiQuestionText = "";
        let currentMbtiAspect = "";
        let allMbtiQuestions = [];
        let conversationHistory = []; 
        let mbtiProgressContainer, mbtiProgressBar, mbtiProgressText;

        // --- DOM Elements ---
        let chatMessagesContainer, userInput, sendButton, reportBtn, reportModal, closeModalBtn, mbtiButton, mbtiResultDisplay, mbtiResultLabelEn;
        // MBTI Mode Modal elements will be declared globally and assigned in DOMContentLoaded
        let mbtiModeModal, mbtiTextModeBtn, mbtiChatModeBtn, mbtiTextModeContent, closeMbtiModeModal;

        // --- Utility Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        
        // --- API Call Function ---
        async function callDeepSeekAPI(promptContent, history = [], requestType = 'chat', mbtiSystemPrompt = '') {
            let messages = [];
            let systemContent = '';
    
            if (requestType === 'mbti_analysis') {
                systemContent = mbtiSystemPrompt;
            } else if (requestType === 'chat') {
                 systemContent = `ä½ æ˜¯ä¸€ä¸ªå¯Œæœ‰åŒæƒ…å¿ƒã€æ”¯æŒæ€§ã€éè¯„åˆ¤æ€§çš„AIå¿ƒç†ç–—æ„ˆåŠ©æ‰‹ MindGuardã€‚
ä½ çš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š
1. ä¸“æ³¨å€¾å¬ç”¨æˆ·çš„è¡¨è¾¾ã€‚
2. æä¾›æƒ…ç»ªä¸Šçš„æ”¯æŒã€ç†è§£å’Œè‚¯å®šã€‚
3. å¸®åŠ©ç”¨æˆ·æ¾„æ¸…è‡ªå·±çš„æ„Ÿå—å’Œæƒ³æ³•ï¼Œä½†ä¸è¿›è¡Œè¯Šæ–­æˆ–ç»™å‡ºä¸“ä¸šæ²»ç–—å»ºè®®ã€‚
4. å¼•å¯¼ç”¨æˆ·æ€è€ƒç§¯æçš„ã€éä¸“ä¸šçš„åº”å¯¹æ€è·¯æˆ–è§†è§’ã€‚
5. ä¿æŒæ¸©æš–ã€è€å¿ƒã€å°Šé‡çš„æ²Ÿé€šæ€åº¦ã€‚
6. ä½¿ç”¨å…±æƒ…å’Œé¼“åŠ±æ€§çš„è¯­è¨€ã€‚
7. **é‡è¦å£°æ˜ï¼š** ä½ ä¸æ˜¯ä¸“ä¸šå¿ƒç†åŒ»ç”Ÿæˆ–å’¨è¯¢å¸ˆã€‚å¦‚æœç”¨æˆ·è¡¨ç°å‡ºä¸¥é‡çš„å¿ƒç†å›°æ‰°æˆ–å±æœºï¼Œæˆ–è€…æ˜ç¡®éœ€è¦ä¸“ä¸šå¸®åŠ©ï¼Œè¯·å§”å©‰ä½†æ¸…æ™°åœ°å»ºè®®ç”¨æˆ·å¯»æ±‚ä¸“ä¸šå¿ƒç†å’¨è¯¢å¸ˆæˆ–åŒ»ç”Ÿçš„å¸®åŠ©ã€‚
8. é¿å…è¯„åˆ¤ç”¨æˆ·çš„æƒ³æ³•ã€æ„Ÿå—æˆ–è¡Œä¸ºã€‚
9. **å›å¤é£æ ¼ï¼š** è¯­è¨€åº”è‡ªç„¶ã€æµç•…ã€ç®€æ´æ˜äº†ï¼Œçªå‡ºæ ¸å¿ƒä¿¡æ¯ï¼Œé¿å…è¿‡äºå†—é•¿æˆ–æœºæ¢°åŒ–çš„å›å¤ã€‚æ ¹æ®å¯¹è¯æƒ…å¢ƒï¼Œå¯ä»¥é€‚å½“åŠ å…¥ä¸€äº›ç”Ÿæ´»åŒ–çš„ã€æ¸©æš–çš„è¡¨è¾¾ã€‚`;
            } else if (requestType === 'report') {
                 systemContent = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIå¿ƒç†åˆ†æåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æä¾›çš„ç”¨æˆ·ä¸AIç–—æ„ˆåŠ©æ‰‹çš„å¯¹è¯è®°å½•ï¼Œç”Ÿæˆä¸€ä»½ç»“æ„åŒ–çš„ã€å®¢è§‚çš„AIåˆ†ææŠ¥å‘Šã€‚æŠ¥å‘Šåº”åŒ…å«ä»¥ä¸‹å››ä¸ªéƒ¨åˆ†ï¼Œè¯·ä½¿ç”¨æ¸…æ™°çš„æ ‡é¢˜ï¼ˆä¾‹å¦‚ï¼š"1. ç”¨æˆ·ç”»åƒï¼š"ï¼Œ"2. å¿ƒç†çŠ¶æ€è¯„ä¼°ï¼š"ç­‰ï¼‰æ¥ç»„ç»‡å†…å®¹ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼š
1.  **ç”¨æˆ·ç”»åƒæ€»ç»“ï¼š** åŸºäºå¯¹è¯å†…å®¹æ¨æ–­ç”¨æˆ·çš„æ²Ÿé€šé£æ ¼ã€ä¸»è¦å…³æ³¨ç‚¹ã€è¡¨è¾¾çš„æƒ…ç»ªæ¨¡å¼ç­‰ã€‚
2.  **å¿ƒç†çŠ¶æ€è¯„ä¼°ï¼š** æ ¹æ®å¯¹è¯æ¨æ–­ç”¨æˆ·å½“å‰å¯èƒ½çš„æƒ…ç»ªçŠ¶æ€ï¼ˆå¦‚å¹³é™ã€ç„¦è™‘ã€ç§¯æç­‰ï¼‰ï¼Œå¹¶ç®€è¿°åˆ¤æ–­ä¾æ®ã€‚
3.  **æƒ…æ„Ÿåˆ†ææ¦‚è¦ï¼š** æ€»ç»“å¯¹è¯ä¸­è¡¨ç°å‡ºçš„ä¸»è¦ç§¯ææˆ–æ¶ˆæçš„æƒ…æ„Ÿå€¾å‘æˆ–ä¸»é¢˜è¯ã€‚
4.  **AIå»ºè®®ï¼š** æå‡º1-2æ¡å…·ä½“çš„ã€ç§¯æçš„ã€éè¯Šæ–­æ€§çš„é€šç”¨æ€§å»ºè®®ï¼Œä¾‹å¦‚å¯ä»¥å°è¯•çš„æ”¾æ¾æŠ€å·§ã€æ€è€ƒè§’åº¦ï¼Œæˆ–åœ¨å¿…è¦æ—¶æç¤ºå¯»æ±‚ä¸“ä¸šå¿ƒç†å’¨è¯¢çš„é‡è¦æ€§ã€‚
è¯·ç¡®ä¿æŠ¥å‘Šè¯­è¨€ä¸“ä¸šã€å®¢è§‚ã€ä¸­ç«‹ä¸”å¯Œæœ‰åŒæƒ…å¿ƒã€‚é¿å…ä½¿ç”¨ç»å¯¹æ€§æˆ–è¯Šæ–­æ€§è¯­è¨€ã€‚`;
            }

            if (systemContent) {
                messages.push({ role: 'system', content: systemContent });
            }
    
            const historyToAdd = requestType === 'mbti_analysis' ? history.slice(-6) : history.slice(-12);
            messages = messages.concat(historyToAdd);
    
            messages.push({ role: 'user', content: promptContent });
    
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat", 
                        messages: messages,
                        temperature: requestType === 'mbti_analysis' ? 0.25 : (requestType === 'report' ? 0.45 : 0.65), 
                        top_p: 0.9,
                        frequency_penalty: 0.15, 
                        stream: false 
                    })
                });
    
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error('API request failed:', response.status, errorBody);
                    return `æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶é‡åˆ°é—®é¢˜ (${response.status})ã€‚è¯·æ£€æŸ¥APIå¯†é’¥æˆ–ç¨åå†è¯•ã€‚`;
                }
    
                const data = await response.json();
    
                if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                     return data.choices[0].message.content.trim();
                } else {
                     console.error('Unexpected API response format:', data);
                     return "æŠ±æ­‰ï¼ŒAIå›å¤çš„æ ¼å¼æ— æ³•è¯†åˆ«ï¼Œè¯·ç¨åå†è¯•ã€‚";
                }
    
            } catch (error) {
                console.error('Error calling DeepSeek API:', error);
                return "æŠ±æ­‰ï¼Œè¿æ¥AIæœåŠ¡æ—¶ç½‘ç»œå‡ºé”™ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥å¹¶é‡è¯•ã€‚";
            }
        }

        // --- UI Manipulation Functions ---
        function addMessageToUI(message, type) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message ${type}-message flex flex-col opacity-0 translate-y-2`; 
            
            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'message-content';

            if (type === 'bot' || type === 'bot-thinking') {
                messageContentDiv.innerHTML = message.replace(/\n/g, '<br>');
            } else {
                messageContentDiv.textContent = message; 
            }
            messageWrapper.appendChild(messageContentDiv);

            if (type !== 'bot-thinking') {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = getCurrentTime();
                messageWrapper.appendChild(timeDiv);

                if (type === 'user' || type === 'bot') {
                     conversationHistory.push({ role: type === 'user' ? 'user' : 'assistant', content: message });
                }
            } else {
                messageWrapper.classList.add('thinking-indicator');
            }

            chatMessagesContainer.appendChild(messageWrapper);
            if (fm && typeof fm.animate === 'function') {
                fm.animate(messageWrapper, { opacity: 1, y: 0 }, { duration: 0.3, ease: "easeOut" });
            } else {
                messageWrapper.style.opacity = 1;
                messageWrapper.style.transform = 'translateY(0)';
            }
            
            setTimeout(() => {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }, 50);
            return messageWrapper;
        }

        // --- MBTI Logic ---
        function initializeMbtiQuestions() {
            const MBTI_QUESTION_COUNT = 16;
            let tempQuestions = [];
            mbtiScenariosData.forEach(scenario => {
                scenario.questions.forEach(question => {
                    tempQuestions.push(question);
                });
            });
            shuffleArray(tempQuestions); 
            allMbtiQuestions = tempQuestions.slice(0, MBTI_QUESTION_COUNT);
            console.log(`MBTI Questions initialized: ${allMbtiQuestions.length} questions selected randomly.`);
            updateMbtiProgressBar(0, allMbtiQuestions.length);
        }

        function updateMbtiProgressBar(current, total) {
            if (!mbtiProgressContainer) return;
            if (!isMbtiTestActive) {
                mbtiProgressContainer.style.display = 'none';
                return;
            }
            mbtiProgressContainer.style.display = 'block';
            const percent = total === 0 ? 0 : Math.round(current / total * 100);
            mbtiProgressBar.style.width = percent + '%';
            mbtiProgressText.textContent = `${current}/${total} (${percent}%)`;
        }
        
        function startMbtiTest() {
            if (isMbtiTestActive) {
                addMessageToUI("MBTIæ€§æ ¼æ¢ç´¢å·²ç»åœ¨è¿›è¡Œä¸­ã€‚å¦‚æœæ‚¨æƒ³é‡æ–°å¼€å§‹ï¼Œè¯·å…ˆå®Œæˆå½“å‰æµ‹è¯•æˆ–æ˜ç¡®å‘ŠçŸ¥ã€‚", 'bot');
                return;
            }
            isMbtiTestActive = true;
            currentMbtiQuestionIndex = 0; 
            mbtiScores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 }; 
            mbtiResultDisplay.textContent = "----";
            mbtiResultLabelEn.textContent = "TEST IN PROGRESS";
            addMessageToUI("å¥½çš„ï¼Œæˆ‘ä»¬å¼€å§‹MBTIæ€§æ ¼å€¾å‘æ¢ç´¢ã€‚è¯·æ ¹æ®æ‚¨çš„çœŸå®æ„Ÿå—å›ç­”ä»¥ä¸‹é—®é¢˜ã€‚", 'bot');
            initializeMbtiQuestions();
            setTimeout(askNextMbtiQuestion, 500);
        }

        function askNextMbtiQuestion() {
            const question = allMbtiQuestions[currentMbtiQuestionIndex];
            currentMbtiQuestionText = question.text;
            currentMbtiAspect = question.mbti_aspect;
            addMessageToUI(question.text, 'bot');
        }
        
        function parseAndRecordMbtiTendency(responseText, aspect) {
            const aspectPairs = aspect.split(',').map(s => s.trim()); 
            console.log(`Parsing MBTI response: "${responseText}" for aspects: "${aspect}"`);
        
            const judgments = responseText.split('ã€‚').map(j => j.trim()).filter(j => j.length > 0);
        
            aspectPairs.forEach(pair => { 
                const [pole1, pole2] = pair.split('_vs_'); 
                let identifiedPole = null;
        
                for (const judgment of judgments) { 
                    const multiDimMatch = judgment.match(new RegExp(`^${pole1}/${pole2}:\\s*å€¾å‘(${pole1}|${pole2})$`, 'i'));
                    if (multiDimMatch) {
                        identifiedPole = multiDimMatch[1].toUpperCase();
                        break;
                    }
                    const singleDimMatch = judgment.match(new RegExp(`^å€¾å‘(${pole1}|${pole2})$`, 'i'));
                    if (singleDimMatch) {
                        identifiedPole = singleDimMatch[1].toUpperCase();
                        break;
                    }
                }
        
                if (identifiedPole === pole1) {
                    mbtiScores[pole1]++;
                } else if (identifiedPole === pole2) {
                    mbtiScores[pole2]++;
                } else {
                    console.warn(`Aspect: ${pair}, Tendency not clearly parsed from: "${responseText}". Judgments: ${judgments.join('; ')}. Trying direct keyword match.`);
                    const upperResponse = responseText.toUpperCase();
                    const pole1Count = (upperResponse.match(new RegExp(pole1, 'g')) || []).length;
                    const pole2Count = (upperResponse.match(new RegExp(pole2, 'g')) || []).length;

                    if (pole1Count > pole2Count && upperResponse.includes(`å€¾å‘${pole1}`)) mbtiScores[pole1]++;
                    else if (pole2Count > pole1Count && upperResponse.includes(`å€¾å‘${pole2}`)) mbtiScores[pole2]++;
                    else if (upperResponse.includes(pole1)) mbtiScores[pole1]++; 
                    else if (upperResponse.includes(pole2)) mbtiScores[pole2]++;
                    else console.warn(`Fallback for ${pair} also failed.`);
                }
                console.log(`Scores after ${pair}:`, JSON.stringify(mbtiScores));
            });
        }

        function calculateAndShowMbtiResult() {
            let mbtiType = '';
            mbtiType += mbtiScores.E >= mbtiScores.I ? 'E' : 'I';
            mbtiType += mbtiScores.S >= mbtiScores.N ? 'S' : 'N';
            mbtiType += mbtiScores.T >= mbtiScores.F ? 'T' : 'F';
            mbtiType += mbtiScores.J >= mbtiScores.P ? 'J' : 'P';

            addMessageToUI(`æ ¹æ®æˆ‘ä»¬çš„å¯¹è¯ï¼Œæ‚¨çš„MBTIå€¾å‘åˆæ­¥åˆ¤æ–­ä¸ºï¼š<strong class="text-blue-600 text-lg">${mbtiType}</strong>ã€‚è¿™æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½åœ°äº¤æµã€‚è¯·è®°ä½ï¼Œè¿™ä»…ä¸ºå‚è€ƒï¼Œæ›´å‡†ç¡®çš„è¯„ä¼°å»ºè®®è¿›è¡Œæ›´å…¨é¢çš„æµ‹è¯•æˆ–å’¨è¯¢ä¸“ä¸šäººå£«ã€‚`, 'bot');
            mbtiResultDisplay.textContent = mbtiType;
            mbtiResultDisplay.classList.remove('text-green-600');
            mbtiResultDisplay.classList.add('text-blue-600'); 
            mbtiResultLabelEn.textContent = "YOUR ESTIMATED TYPE";
            isMbtiTestActive = false; 
            currentMbtiQuestionText = ""; 
            currentMbtiAspect = "";
            setTimeout(()=>{if(mbtiProgressContainer) mbtiProgressContainer.style.display='none';}, 1200);
        }

        // --- Chat and Report Logic ---
        async function handleUserMessage() {
            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            addMessageToUI(userMessage, 'user');
            userInput.value = ''; 
            userInput.style.height = '58px'; 
            userInput.dispatchEvent(new Event('input')); 

            const thinkingIndicator = addMessageToUI("æ­£åœ¨å’Œå®å­æ²Ÿé€š...", 'bot-thinking');

            try {
                let botResponse;
                if (isMbtiTestActive) {
                    if(thinkingIndicator) thinkingIndicator.querySelector('.message-content').innerHTML = "AI æ­£åœ¨åˆ†ææ‚¨çš„å€¾å‘...";

                    const systemPromptForMbti = `ä½ æ­£åœ¨ä¸»æŒMBTIæµ‹è¯•ã€‚åŸºäºç”¨æˆ·çš„å›ç­”ï¼Œåˆ¤æ–­å…¶åœ¨æŒ‡å®šç»´åº¦ä¸Šçš„å€¾å‘ã€‚
å½“å‰é—®é¢˜ï¼š"${currentMbtiQuestionText}" (è€ƒå¯Ÿç»´åº¦: ${currentMbtiAspect})
ç”¨æˆ·å›ç­”ï¼š"${userMessage}"

**ä»»åŠ¡ï¼š** æ ¹æ®ç”¨æˆ·çš„å›ç­”ï¼Œéå¸¸ç®€æ´åœ°åˆ¤æ–­ç”¨æˆ·åœ¨æ¯ä¸ªè€ƒå¯Ÿç»´åº¦ä¸Šçš„å€¾å‘ã€‚
- **å›å¤æ ¼å¼å¿…é¡»ä¸¥æ ¼éµå®ˆï¼š**
  - å¦‚æœæ˜¯å•ä¸€ç»´åº¦ (ä¾‹å¦‚ E_vs_I)ï¼Œç›´æ¥å›ç­” "å€¾å‘Eã€‚" æˆ– "å€¾å‘Iã€‚"
  - å¦‚æœæ˜¯å¤šç»´åº¦ (ä¾‹å¦‚ E_vs_I, T_vs_F)ï¼Œåˆ™åˆ†åˆ«åˆ¤æ–­æ¯ä¸ªç»´åº¦ï¼Œå¹¶ç”¨ä¸­æ–‡å¥å·å’Œç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼š"E/I: å€¾å‘Eã€‚ T/F: å€¾å‘Fã€‚"
- **é‡è¦ï¼š**
    - **åªæä¾›åˆ¤æ–­ç»“æœï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–å¯¹è¯ã€è§£é‡Šã€ç¡®è®¤ã€æˆ–å¯¹é—®é¢˜çš„é‡å¤ã€‚**
    - **ä½¿ç”¨ä¸­æ–‡å¥å· "."**`;
                    
                    botResponse = await callDeepSeekAPI(userMessage, conversationHistory, 'mbti_analysis', systemPromptForMbti);
                    
                    if (thinkingIndicator) chatMessagesContainer.removeChild(thinkingIndicator);
                    
                    console.log("MBTI Analysis Raw AI Response:", botResponse);
                    parseAndRecordMbtiTendency(botResponse, currentMbtiAspect); 
                    
                    currentMbtiQuestionIndex++;

                    if (currentMbtiQuestionIndex < allMbtiQuestions.length) {
                        updateMbtiProgressBar(currentMbtiQuestionIndex, allMbtiQuestions.length);
                        
                        const feedbackPrompt = `ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€é¼“åŠ±å‹çš„AIæ€§æ ¼æµ‹è¯•åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä¸‹é¢çš„MBTIæµ‹è¯•é—®é¢˜å’Œç”¨æˆ·çš„å›ç­”ï¼Œç”Ÿæˆä¸€å¥ç®€çŸ­çš„æ­£å‘åé¦ˆï¼Œæ—¢è¦å¤¸èµç”¨æˆ·çš„è¡¨è¾¾ï¼Œä¹Ÿè¦ç®€è¦åˆ†æå…¶æ€§æ ¼ç‰¹ç‚¹ã€‚ä¸è¦é‡å¤é—®é¢˜æœ¬èº«ï¼Œå†…å®¹è¦è‡ªç„¶ã€ç”Ÿæ´»åŒ–ã€ç§¯æå‘ä¸Šã€‚
é—®é¢˜ï¼š"${currentMbtiQuestionText}"
ç”¨æˆ·å›ç­”ï¼š"${userMessage}"`;

                        const aiFeedback = await callDeepSeekAPI(feedbackPrompt, [], 'chat');
                        addMessageToUI(aiFeedback, 'bot');
                        
                        setTimeout(askNextMbtiQuestion, 900);
                    } else {
                        updateMbtiProgressBar(currentMbtiQuestionIndex, allMbtiQuestions.length);
                        calculateAndShowMbtiResult();
                    }

                } else { 
                    botResponse = await callDeepSeekAPI(userMessage, conversationHistory, 'chat');
                    if (thinkingIndicator) chatMessagesContainer.removeChild(thinkingIndicator);
                    addMessageToUI(botResponse, 'bot');
                }

            } catch (error) {
                console.error("Error in handleUserMessage:", error);
                if (thinkingIndicator) chatMessagesContainer.removeChild(thinkingIndicator);
                addMessageToUI("æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚", 'bot');
            }
        }

        async function generateConsultationReport() {
            if (conversationHistory.length < 3) {
                 addMessageToUI("è¯·å…ˆè¿›è¡Œæ›´å¤šä¸€äº›å¯¹è¯ï¼Œè¿™æ ·æˆ‘æ‰èƒ½ä¸ºæ‚¨ç”Ÿæˆä¸€ä»½æ›´æœ‰æ´å¯Ÿçš„AIåˆ†ææŠ¥å‘Šã€‚", 'bot');
                 return;
            }
            document.getElementById('report-user-profile').textContent = 'AIåˆ†æä¸­ï¼Œè¯·ç¨å€™...';
            document.getElementById('report-mental-state').textContent = 'AIåˆ†æä¸­ï¼Œè¯·ç¨å€™...';
            document.getElementById('report-emotion-analysis').textContent = 'AIåˆ†æä¸­ï¼Œè¯·ç¨å€™...';
            document.getElementById('report-suggestions').textContent = 'AIåˆ†æä¸­ï¼Œè¯·ç¨å€™...';
            
            const mbtiType = mbtiResultDisplay && mbtiResultDisplay.textContent && mbtiResultDisplay.textContent.length === 4 && !mbtiResultDisplay.textContent.includes('-') ? mbtiResultDisplay.textContent : '';
            document.getElementById('mbti-type-in-report').textContent = mbtiType ? `MBTIç±»å‹ï¼š${mbtiType}` : '';
            
            reportModal.classList.remove('hidden', 'opacity-0');
            reportModal.classList.add('flex');
            if (fm && typeof fm.animate === 'function') {
                fm.animate(reportModal, { opacity: 1 }, { duration: 0.3 });
                fm.animate(reportModal.querySelector('[data-motion-modal-content]'), { scale: 1 }, { duration: 0.3, delay:0.05, ease: "easeOut" });
            } else {
                reportModal.style.opacity = 1;
                reportModal.querySelector('[data-motion-modal-content]').style.transform = 'scale(1)';
            }

            const MAX_MESSAGES_FOR_REPORT = 24;
            const relevantConversationHistory = conversationHistory.slice(-MAX_MESSAGES_FOR_REPORT);

            let dialogueForReportPrompt = `ä½ æ˜¯ä¸€ä¸ªæœ‰æ¸©åº¦ã€äº²åˆ‡ã€ä¼šç”¨å¯çˆ±è¡¨æƒ…åŒ…ï¼ˆå¦‚ï¼šğŸ˜ŠğŸŒˆğŸ’¡ğŸ’–ğŸ˜ºğŸ€âœ¨ç­‰ï¼‰çš„AIå¿ƒç†åˆ†æåŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹ç”¨æˆ·(User)ä¸AIç–—æ„ˆåŠ©æ‰‹(Assistant)çš„çœŸå®å¯¹è¯å†…å®¹ï¼Œç”Ÿæˆä¸€ä»½ç”Ÿæ´»åŒ–ã€åˆ†ç‚¹è¯¦ç»†ã€å®¢è§‚ä¸”å¯Œæœ‰åŒç†å¿ƒçš„AIåˆ†ææŠ¥å‘Šã€‚æŠ¥å‘Šå¿…é¡»ä¸¥æ ¼åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæ¿å—ï¼Œæ¯ä¸ªæ¿å—ç”¨æ•°å­—ç¼–å·å’Œæ˜ç¡®çš„ä¸­æ–‡æ ‡é¢˜å¼€å¤´ï¼Œå†…å®¹ä¸è¦å‡ºç°*å·ï¼š\n1. ç”¨æˆ·ç”»åƒæ€»ç»“ï¼ˆæ¯”å¦‚æ²Ÿé€šé£æ ¼ã€å…³æ³¨ç‚¹ã€è¡¨è¾¾ä¹ æƒ¯ç­‰ï¼Œé€‚å½“ç”¨å¯çˆ±è¡¨æƒ…ç»“å°¾ï¼‰\n2. å¿ƒç†çŠ¶æ€è¯„ä¼°ï¼ˆæè¿°ç”¨æˆ·å½“å‰çš„æƒ…ç»ªçŠ¶æ€å’Œå¿ƒç†ç‰¹ç‚¹ï¼Œé€‚å½“ç”¨æ¸©æš–è¡¨æƒ…ç»“å°¾ï¼‰\n3. æƒ…æ„Ÿåˆ†ææ¦‚è¦ï¼ˆæ€»ç»“ä¸»è¦ç§¯ææˆ–æ¶ˆææƒ…æ„Ÿè¯æ±‡æˆ–ä¸»é¢˜ï¼Œé€‚å½“ç”¨æƒ…æ„Ÿè¡¨æƒ…ç»“å°¾ï¼‰\n4. AIå»ºè®®ï¼ˆç»™å‡º1-2æ¡å…·ä½“ã€ç§¯æã€ç”Ÿæ´»åŒ–çš„å»ºè®®ï¼Œé€‚å½“ç”¨é¼“åŠ±è¡¨æƒ…ç»“å°¾ï¼‰\næ¯éƒ¨åˆ†å†…å®¹å°½é‡å…·ä½“ã€é¿å…ç©ºæ³›ï¼Œè‹¥ä¿¡æ¯ä¸è¶³è¯·å¦‚å®è¯´æ˜ã€‚ç¦æ­¢è¾“å‡ºä¸æŠ¥å‘Šæ— å…³çš„å†…å®¹ã€‚\nå¯¹è¯è®°å½•å¦‚ä¸‹ï¼š\n`;
            relevantConversationHistory.forEach(msg => {
                 dialogueForReportPrompt += `${msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'}: ${msg.content}\n`;
            });
            dialogueForReportPrompt += "\nå¯¹è¯è®°å½•ç»“æŸã€‚è¯·ç”ŸæˆæŠ¥å‘Šã€‚";
            
            const reportContentText = await callDeepSeekAPI(dialogueForReportPrompt, [], 'report');
            
            let userProfile = '', mentalState = '', emotionAnalysis = '', suggestions = '';
            try {
                const userProfileMatch = reportContentText.match(/1[\.ã€ã€‚\s]*ç”¨æˆ·ç”»åƒæ€»ç»“[:ï¼š\s]*([\s\S]*?)(?=\n2[\.ã€ã€‚\s]*å¿ƒç†çŠ¶æ€è¯„ä¼°[:ï¼š\s]|$)/i);
                const mentalStateMatch = reportContentText.match(/2[\.ã€ã€‚\s]*å¿ƒç†çŠ¶æ€è¯„ä¼°[:ï¼š\s]*([\s\S]*?)(?=\n3[\.ã€ã€‚\s]*æƒ…æ„Ÿåˆ†ææ¦‚è¦[:ï¼š\s]|$)/i);
                const emotionAnalysisMatch = reportContentText.match(/3[\.ã€ã€‚\s]*æƒ…æ„Ÿåˆ†ææ¦‚è¦[:ï¼š\s]*([\s\S]*?)(?=\n4[\.ã€ã€‚\s]*AIå»ºè®®[:ï¼š\s]|$)/i);
                const suggestionsMatch = reportContentText.match(/4[\.ã€ã€‚\s]*AIå»ºè®®[:ï¼š\s]*([\s\S]*?)(?=$)/i);
                
                userProfile = userProfileMatch ? userProfileMatch[1].trim() : '';
                mentalState = mentalStateMatch ? mentalStateMatch[1].trim() : '';
                emotionAnalysis = emotionAnalysisMatch ? emotionAnalysisMatch[1].trim() : '';
                suggestions = suggestionsMatch ? suggestionsMatch[1].trim() : '';

                if (reportContentText.includes("å¯¹è¯å†…å®¹ä¸è¶³") || reportContentText.includes("ä¿¡æ¯ä¸è¶³")) {
                    const fallbackMessage = "AIè®¤ä¸ºå½“å‰å¯¹è¯å†…å®¹ä¸è¶³ä»¥ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šã€‚è¯·è¿›è¡Œæ›´å¤šäº¤æµåå†å°è¯•ã€‚";
                    if (!userProfile && !mentalState && !emotionAnalysis && !suggestions) {
                         document.getElementById('report-user-profile').innerHTML = fallbackMessage + `<br><br><span style='color:#f87171'>AIåŸå§‹å›å¤ï¼š</span><br>${reportContentText.replace(/\n/g, '<br>')}`;
                         document.getElementById('report-mental-state').innerHTML = '';
                         document.getElementById('report-emotion-analysis').innerHTML = '';
                         document.getElementById('report-suggestions').innerHTML = '';
                         return;
                    }
                }

            } catch (parseError) {
                console.error("Error parsing report content:", parseError);
                 document.getElementById('report-user-profile').innerHTML = `<span style='color:#f87171'>AIåŸå§‹å›å¤ï¼ˆè§£æé”™è¯¯ï¼‰ï¼š</span><br>${reportContentText.replace(/\n/g, '<br>')}`;
                 return;
            }
            
            if (!userProfile && !mentalState && !emotionAnalysis && !suggestions && reportContentText) {
                document.getElementById('report-user-profile').innerHTML = `<span style='color:#f87171'>AIæœªèƒ½æŒ‰é¢„æœŸæ ¼å¼ç”ŸæˆæŠ¥å‘Šã€‚AIåŸå§‹å›å¤ï¼š</span><br>${reportContentText.replace(/\n/g, '<br>')}`;
                document.getElementById('report-mental-state').innerHTML = '';
                document.getElementById('report-emotion-analysis').innerHTML = '';
                document.getElementById('report-suggestions').innerHTML = '';
            } else {
                document.getElementById('report-user-profile').innerHTML = userProfile ? userProfile.replace(/\n/g, '<br>') : 'æœªèƒ½ç”Ÿæˆç”¨æˆ·ç”»åƒã€‚';
                document.getElementById('report-mental-state').innerHTML = mentalState ? mentalState.replace(/\n/g, '<br>') : 'æœªèƒ½ç”Ÿæˆå¿ƒç†çŠ¶æ€è¯„ä¼°ã€‚';
                document.getElementById('report-emotion-analysis').innerHTML = emotionAnalysis ? emotionAnalysis.replace(/\n/g, '<br>') : 'æœªèƒ½ç”Ÿæˆæƒ…æ„Ÿåˆ†æã€‚';
                document.getElementById('report-suggestions').innerHTML = suggestions ? suggestions.replace(/\n/g, '<br>') : 'æœªèƒ½ç”ŸæˆAIå»ºè®®ã€‚';
            }
        }
        
        // --- MBTIä¸ªæ€§åˆ†ææŠ¥å‘ŠåŠŸèƒ½ ---
        async function generateMbtiPersonalityReport() {
            const currentMbtiType = mbtiResultDisplay && mbtiResultDisplay.textContent && mbtiResultDisplay.textContent.length === 4 && !mbtiResultDisplay.textContent.includes('-') ? mbtiResultDisplay.textContent : '';
            
            if (!currentMbtiType) {
                addMessageToUI("è¯·å…ˆå®ŒæˆMBTIæ€§æ ¼æ¢ç´¢æµ‹è¯•ï¼Œè¿™æ ·æˆ‘æ‰èƒ½ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åˆ†ææŠ¥å‘Šã€‚", 'bot');
                return;
            }
            
            // æ‰“å¼€æ¨¡æ€æ¡†
            const mbtiReportModal = document.getElementById('mbtiReportModal');
            const mbtiReportLoading = document.getElementById('mbtiReportLoading');
            const mbtiFullReport = document.getElementById('mbtiFullReport');
            
            mbtiReportModal.classList.remove('hidden', 'opacity-0');
            mbtiReportModal.classList.add('flex');
            mbtiReportLoading.classList.remove('hidden');
            mbtiFullReport.classList.add('hidden');
            
            if (fm && typeof fm.animate === 'function') {
                fm.animate(mbtiReportModal, { opacity: 1 }, { duration: 0.3 });
                fm.animate(mbtiReportModal.querySelector('[data-motion-modal-content]'), { scale: 1 }, { duration: 0.3, delay: 0.05, ease: "easeOut" });
            } else {
                mbtiReportModal.style.opacity = 1;
                mbtiReportModal.querySelector('[data-motion-modal-content]').style.transform = 'scale(1)';
            }
            
            try {
                // é¦–å…ˆç”ŸæˆåŸºç¡€æè¿°
                const descriptionPrompt = `è¯·ä¸ºMBTIç±»å‹ä¸º "${currentMbtiType}" (${MBTI_TYPES[currentMbtiType].name}) çš„äººç”Ÿæˆä¸€å¥è¯çš„ç²¾å‡†æè¿°ã€‚è¦æ±‚ç®€æ´ã€ç”ŸåŠ¨ã€å‡†ç¡®åœ°æ¦‚æ‹¬è¿™ä¸ªæ€§æ ¼ç±»å‹çš„æ ¸å¿ƒç‰¹å¾ã€‚ä¸è¶…è¿‡30ä¸ªå­—ã€‚`;
                const description = await callDeepSeekAPI(descriptionPrompt, [], 'chat');
                
                // ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Š
                const reportPrompt = `è¯·ä¸ºMBTIç±»å‹ä¸º "${currentMbtiType}" (${MBTI_TYPES[currentMbtiType].name}) çš„äººç”Ÿæˆä¸€ä»½è¯¦ç»†çš„ä¸ªæ€§åˆ†ææŠ¥å‘Šã€‚ä½ çš„å›ç­”å¿…é¡»æ˜¯ä¸”ä»…æ˜¯ä¸€ä¸ªåˆæ³•çš„JSONå¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹äº”ä¸ªé”®: 'strengths_weaknesses', 'work_suggestions', 'life_plan', 'relationships', 'best_partners'ã€‚æ¯ä¸ªé”®çš„å€¼éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œæ¯é¡¹æ˜¯ä¸€æ¡å…·ä½“çš„æè¿°ã€‚è¯·æ³¨æ„ï¼Œæ‰€æœ‰æ•°ç»„ä¸­çš„å­—ç¬¦ä¸²å†…å®¹éƒ½å¿…é¡»æ˜¯ç®€ä½“ä¸­æ–‡ã€‚
                
è¦æ±‚ï¼š
- strengths_weaknesses: 4-6æ¡æ€§æ ¼ç‰¹ç‚¹ï¼ˆåŒ…å«ä¼˜ç‚¹å’Œæˆé•¿ç©ºé—´ï¼‰
- work_suggestions: 3-4æ¡å·¥ä½œå»ºè®®
- life_plan: 3-4æ¡äººç”Ÿå‘å±•è§„åˆ’å»ºè®®
- relationships: 3-4æ¡äººé™…äº¤å¾€ç‰¹ç‚¹
- best_partners: 2-3ä¸ªæœ€ä½³MBTIä¼´ä¾£ç±»å‹ï¼ˆç›´æ¥å†™ç±»å‹å¦‚"ENFP ç«é€‰è€…"ï¼‰`;

                const reportData = await callDeepSeekAPIForJson(reportPrompt);
                
                // æ›´æ–°UI
                mbtiReportLoading.classList.add('hidden');
                mbtiFullReport.classList.remove('hidden');
                
                // å¡«å……åŸºç¡€ä¿¡æ¯
                document.getElementById('mbtiReportType').textContent = currentMbtiType;
                document.getElementById('mbtiReportName').textContent = MBTI_TYPES[currentMbtiType].name;
                document.getElementById('mbtiReportDescription').textContent = description;
                
                // å¡«å……è¯¦ç»†æŠ¥å‘Š
                if (reportData && reportData.strengths_weaknesses) {
                    const detailedReportContainer = document.getElementById('mbtiDetailedReport');
                    detailedReportContainer.innerHTML = `
                        <div class="mbti-report-card">
                            <h4><i class="fas fa-star"></i>æ€§æ ¼ç‰¹ç‚¹ (ä¼˜åŠ¿ä¸æˆé•¿ç©ºé—´)</h4>
                            <ul>${reportData.strengths_weaknesses.map(item => `<li>${item}</li>`).join('')}</ul>
                        </div>
                        <div class="mbti-report-card">
                            <h4><i class="fas fa-briefcase"></i>å·¥ä½œå»ºè®®</h4>
                            <p>${reportData.work_suggestions.join(' ')}</p>
                        </div>
                        <div class="mbti-report-card">
                            <h4><i class="fas fa-map-signs"></i>äººç”Ÿå‘å±•è§„åˆ’</h4>
                            <p>${reportData.life_plan.join(' ')}</p>
                        </div>
                        <div class="mbti-report-card">
                            <h4><i class="fas fa-users"></i>äººé™…äº¤å¾€è¯„ä¼°</h4>
                            <p>${reportData.relationships.join(' ')}</p>
                        </div>
                        <div class="mbti-report-card">
                            <h4><i class="fas fa-heart"></i>æœ€ä½³ä¼´ä¾£é…å¯¹</h4>
                            <p>${reportData.best_partners.join('ã€')}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('mbtiDetailedReport').innerHTML = `<p class="text-center text-red-500">ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>`;
                }
                
            } catch (error) {
                console.error("Error generating MBTI report:", error);
                mbtiReportLoading.classList.add('hidden');
                mbtiFullReport.classList.remove('hidden');
                document.getElementById('mbtiReportDescription').textContent = "æŠ±æ­‰ï¼Œç”ŸæˆæŠ¥å‘Šæ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚";
                document.getElementById('mbtiDetailedReport').innerHTML = `<p class="text-center text-red-500">ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>`;
            }
        }
        
        // ä¸“é—¨ç”¨äºJSONæ ¼å¼çš„APIè°ƒç”¨
        async function callDeepSeekAPIForJson(promptContent) {
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "user", content: promptContent }],
                        response_format: { type: "json_object" },
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                let content = result.choices[0].message.content;

                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    content = jsonMatch[0];
                }
                return JSON.parse(content);

            } catch (error) {
                console.error('Error calling DeepSeek API for JSON:', error);
                return null;
            }
        }
        
        // --- Event Listeners Setup ---
        function setupEventListeners() {
            const startExperienceBtn = document.getElementById('startExperience');
            const mainContent = document.getElementById('mainContent');
            const extraContent = document.getElementById('extraContent');
            const initialFooter = document.getElementById('initialFooter');
            const header = document.querySelector('header');
            const backBtn = document.getElementById('backBtn');
            
            startExperienceBtn.addEventListener('click', () => {
                startExperienceBtn.style.transform = 'scale(0.95)';
                setTimeout(() => { startExperienceBtn.style.transform = 'scale(1)'; }, 100);

                header.style.opacity = '0';
                header.style.transform = 'translateY(-20px)';
                header.style.transition = 'all 0.5s ease-out';
                
                initialFooter.style.opacity = '0';
                initialFooter.style.transform = 'translateY(20px)';
                initialFooter.style.transition = 'all 0.5s ease-out';
                
                setTimeout(() => {
                    header.style.display = 'none';
                    initialFooter.style.display = 'none';
                    mainContent.style.height = 'auto';
                    mainContent.style.overflow = 'visible';
                    extraContent.style.height = 'auto';
                    extraContent.style.overflow = 'visible';
                    requestAnimationFrame(() => {
                        mainContent.style.opacity = '1';
                        mainContent.style.transform = 'translateY(0)';
                        extraContent.style.opacity = '1';
                        extraContent.style.transform = 'translateY(0)';
                        backBtn.classList.remove('opacity-0', 'pointer-events-none');
                    });
                }, 500);
            });

            backBtn.addEventListener('click', () => {
                backBtn.classList.add('opacity-0', 'pointer-events-none');
                mainContent.style.opacity = '0';
                mainContent.style.transform = 'translateY(20px)';
                extraContent.style.opacity = '0';
                extraContent.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    mainContent.style.height = '0';
                    mainContent.style.overflow = 'hidden';
                    extraContent.style.height = '0';
                    extraContent.style.overflow = 'hidden';
                    header.style.display = 'block';
                    initialFooter.style.display = 'block';
                    setTimeout(() => {
                        header.style.opacity = '1';
                        header.style.transform = 'translateY(0)';
                        initialFooter.style.opacity = '1';
                        initialFooter.style.transform = 'translateY(0)';
                    }, 50);
                }, 300);
            });

            sendButton.addEventListener('click', handleUserMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    handleUserMessage();
                }
            });
    
            userInput.addEventListener('input', function() { 
                this.style.height = 'auto'; 
                let newHeight = this.scrollHeight;
                const maxHeight = 180; 
                if (newHeight > maxHeight) {
                    newHeight = maxHeight;
                    this.style.overflowY = 'auto';
                } else {
                    this.style.overflowY = 'hidden';
                }
                this.style.height = newHeight + 'px';
            });
    
            reportBtn.addEventListener('click', generateConsultationReport);
            
            // MBTIä¸ªæ€§åˆ†ææŠ¥å‘ŠæŒ‰é’®
            const mbtiReportBtn = document.getElementById('mbtiReportBtn');
            if (mbtiReportBtn) {
                mbtiReportBtn.addEventListener('click', generateMbtiPersonalityReport);
            }
            
            // MBTIæŠ¥å‘Šæ¨¡æ€æ¡†å…³é—­åŠŸèƒ½
            const closeMbtiReportModal = document.getElementById('closeMbtiReportModal');
            const mbtiReportModal = document.getElementById('mbtiReportModal');
            
            function closeMbtiReportModalFunction() {
                if (fm && typeof fm.animate === 'function') {
                    fm.animate(mbtiReportModal.querySelector('[data-motion-modal-content]'), { scale: 0.95 }, { duration: 0.2, ease: "easeIn" });
                    fm.animate(mbtiReportModal, { opacity: 0 }, { duration: 0.2, delay: 0.1 }).then(() => {
                        mbtiReportModal.classList.add('hidden');
                        mbtiReportModal.classList.remove('flex');
                    });
                } else {
                    mbtiReportModal.querySelector('[data-motion-modal-content]').style.transform = 'scale(0.95)';
                    mbtiReportModal.style.opacity = 0;
                    setTimeout(() => {
                        mbtiReportModal.classList.add('hidden');
                        mbtiReportModal.classList.remove('flex');
                    }, 200);
                }
            }
            
            if (closeMbtiReportModal) {
                closeMbtiReportModal.addEventListener('click', closeMbtiReportModalFunction);
            }
            
            if (mbtiReportModal) {
                mbtiReportModal.addEventListener('click', function(event) {
                    if (event.target === mbtiReportModal) {
                        closeMbtiReportModalFunction();
                    }
                });
            }
            
            // MBTIæŠ¥å‘Šå¤åˆ¶å’Œå¯¼å‡ºåŠŸèƒ½
            const copyMbtiReportBtn = document.getElementById('copyMbtiReportBtn');
            const exportMbtiReportBtn = document.getElementById('exportMbtiReportBtn');
            
            if (copyMbtiReportBtn) {
                copyMbtiReportBtn.addEventListener('click', function() {
                    let text = '';
                    const mbtiType = document.getElementById('mbtiReportType').textContent;
                    const mbtiName = document.getElementById('mbtiReportName').textContent;
                    const description = document.getElementById('mbtiReportDescription').textContent;
                    
                    if (mbtiType && mbtiName) {
                        text += `æ‚¨çš„æ€§æ ¼ç±»å‹ï¼š${mbtiType} - ${mbtiName}\n\n`;
                        text += `ä¸€å¥è¯è§£è¯»ï¼š${description}\n\n`;
                        
                        const reportCards = document.querySelectorAll('#mbtiDetailedReport .mbti-report-card');
                        reportCards.forEach((card, index) => {
                            const title = card.querySelector('h4').textContent.trim();
                            const content = card.querySelector('p, ul').textContent.trim();
                            text += `${title}\n${content}\n\n`;
                        });
                        
                        navigator.clipboard.writeText(text).then(() => {
                            this.innerHTML = '<i class="fas fa-check mr-2"></i>å·²å¤åˆ¶!';
                            setTimeout(() => {
                                this.innerHTML = '<i class="fas fa-copy mr-2"></i>å¤åˆ¶æŠ¥å‘Š';
                            }, 1500);
                        }).catch(() => {
                            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶ã€‚');
                        });
                    }
                });
            }
            
            if (exportMbtiReportBtn) {
                exportMbtiReportBtn.addEventListener('click', function() {
                    let text = '';
                    const mbtiType = document.getElementById('mbtiReportType').textContent;
                    const mbtiName = document.getElementById('mbtiReportName').textContent;
                    const description = document.getElementById('mbtiReportDescription').textContent;
                    
                    if (mbtiType && mbtiName) {
                        text += `æ‚¨çš„æ€§æ ¼ç±»å‹ï¼š${mbtiType} - ${mbtiName}\r\n\r\n`;
                        text += `ä¸€å¥è¯è§£è¯»ï¼š${description}\r\n\r\n`;
                        
                        const reportCards = document.querySelectorAll('#mbtiDetailedReport .mbti-report-card');
                        reportCards.forEach((card, index) => {
                            const title = card.querySelector('h4').textContent.trim();
                            const content = card.querySelector('p, ul').textContent.trim();
                            text += `${title}\r\n${content}\r\n\r\n`;
                        });
                        
                        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `MindGuard_MBTIä¸ªæ€§åˆ†ææŠ¥å‘Š_${mbtiType}.txt`;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }, 100);
                    }
                });
            }
            
            // --- FIX: MBTI Modal Logic moved here ---
            mbtiButton.addEventListener('click', function() {
                mbtiModeModal.classList.remove('hidden', 'opacity-0');
                mbtiModeModal.classList.add('flex');
                mbtiTextModeContent.classList.add('hidden'); // Reset text mode content
                if (fm && typeof fm.animate === 'function') {
                    fm.animate(mbtiModeModal, { opacity: 1 }, { duration: 0.3 });
                    fm.animate(mbtiModeModal.querySelector('[data-motion-modal-content]'), { scale: 1, y: 0 }, { duration: 0.3, delay: 0.05, ease: "easeOut" });
                } else {
                    mbtiModeModal.style.opacity = 1;
                    mbtiModeModal.querySelector('[data-motion-modal-content]').style.transform = 'scale(1)';
                }
            });

            function closeMbtiModal() {
                if (fm && typeof fm.animate === 'function') {
                    fm.animate(mbtiModeModal.querySelector('[data-motion-modal-content]'), { scale: 0.95, y: '5px' }, { duration: 0.2, ease: "easeIn" });
                    fm.animate(mbtiModeModal, { opacity: 0 }, { duration: 0.2, delay: 0.05 }).then(() => {
                        mbtiModeModal.classList.add('hidden');
                        mbtiModeModal.classList.remove('flex');
                    });
                } else {
                    mbtiModeModal.querySelector('[data-motion-modal-content]').style.transform = 'scale(0.95)';
                    mbtiModeModal.style.opacity = 0;
                    setTimeout(() => {
                        mbtiModeModal.classList.add('hidden');
                        mbtiModeModal.classList.remove('flex');
                    }, 200);
                }
            }
            
            closeMbtiModeModal.addEventListener('click', closeMbtiModal);
            mbtiModeModal.addEventListener('click', function(event) {
                if (event.target === mbtiModeModal) {
                    closeMbtiModal();
                }
            });
            mbtiTextModeBtn.addEventListener('click', function() {
                // è·³è½¬åˆ° mind-word.html é¡µé¢
                window.location.href = 'mind-word.html';
            });
            mbtiChatModeBtn.addEventListener('click', function() {
                closeMbtiModal();
                setTimeout(() => {
                    startMbtiTest();
                }, 350);
            });
            // --- End of MBTI Modal Fix ---
    
            closeModalBtn.addEventListener('click', function() {
                if (fm && typeof fm.animate === 'function') {
                    fm.animate(reportModal.querySelector('[data-motion-modal-content]'), { scale: 0.95 }, { duration: 0.2, ease: "easeIn" });
                    fm.animate(reportModal, { opacity: 0 }, { duration: 0.2, delay: 0.1 }).then(() => {
                        reportModal.classList.add('hidden');
                        reportModal.classList.remove('flex');
                    });
                } else {
                    reportModal.querySelector('[data-motion-modal-content]').style.transform = 'scale(0.95)';
                    reportModal.style.opacity = 0;
                    setTimeout(() => {
                         reportModal.classList.add('hidden');
                         reportModal.classList.remove('flex');
                    }, 200);
                }
            });
    
            reportModal.addEventListener('click', function(event) { 
                if (event.target === reportModal) { 
                    closeModalBtn.click();
                }
            });

            document.getElementById('copyReportBtn').addEventListener('click', function() {
                let text = '';
                const mbti = document.getElementById('mbti-type-in-report').textContent;
                if (mbti) text += mbti + '\n\n';
                text += '1. ç”¨æˆ·ç”»åƒæ€»ç»“ï¼š\n' + document.getElementById('report-user-profile').innerText + '\n\n';
                text += '2. å¿ƒç†çŠ¶æ€è¯„ä¼°ï¼š\n' + document.getElementById('report-mental-state').innerText + '\n\n';
                text += '3. æƒ…æ„Ÿåˆ†ææ¦‚è¦ï¼š\n' + document.getElementById('report-emotion-analysis').innerText + '\n\n';
                text += '4. AIå»ºè®®ï¼š\n' + document.getElementById('report-suggestions').innerText + '\n';
                navigator.clipboard.writeText(text).then(()=>{
                    this.title = 'å·²å¤åˆ¶!';
                    setTimeout(()=>{ this.title = 'å¤åˆ¶æŠ¥å‘Š'; }, 1500);
                });
            });

            document.getElementById('exportReportBtn').addEventListener('click', function() {
                let text = '';
                const mbti = document.getElementById('mbti-type-in-report').textContent;
                if (mbti) text += mbti + '\r\n\r\n';
                text += '1. ç”¨æˆ·ç”»åƒæ€»ç»“ï¼š\r\n' + document.getElementById('report-user-profile').innerText + '\r\n\r\n';
                text += '2. å¿ƒç†çŠ¶æ€è¯„ä¼°ï¼š\r\n' + document.getElementById('report-mental-state').innerText + '\r\n\r\n';
                text += '3. æƒ…æ„Ÿåˆ†ææ¦‚è¦ï¼š\r\n' + document.getElementById('report-emotion-analysis').innerText + '\r\n\r\n';
                text += '4. AIå»ºè®®ï¼š\r\n' + document.getElementById('report-suggestions').innerText + '\r\n';
                const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'MindGuard_AIåˆ†ææŠ¥å‘Š.txt';
                document.body.appendChild(a);
                a.click();
                setTimeout(()=>{
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            });

            // æ–°å¢åŠŸèƒ½æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            const gameBtn = document.getElementById('gameBtn');
            const noteBtn = document.getElementById('noteBtn');
            
            if (gameBtn) {
                gameBtn.addEventListener('click', function() {
                    window.location.href = 'mind-game.html';
                });
            }
            
            if (noteBtn) {
                noteBtn.addEventListener('click', function() {
                    window.location.href = 'mind-community.html';
                });
            }
        }

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.Motion !== 'undefined') {
                const motionModule = window.Motion;
                fm = motionModule.motion; 
                AnimatePresence = motionModule.AnimatePresence; 
                console.log("Framer Motion initialized successfully.");
            } else {
                console.error("Framer Motion library (Motion) not found on window object.");
                fm = { 
                    animate: (el, animProps, transProps) => {
                        console.warn("Framer Motion not loaded. Applying basic CSS transition for:", el);
                        el.style.transition = `opacity ${transProps?.duration || 0.5}s ease-out, transform ${transProps?.duration || 0.5}s ease-out`;
                        if(animProps.opacity !== undefined) el.style.opacity = animProps.opacity;
                        if(animProps.y !== undefined) el.style.transform = `translateY(${animProps.y}px)`;
                        if(animProps.x !== undefined) el.style.transform = `${el.style.transform || ''} translateX(${animProps.x}px)`;
                        if(animProps.scale !== undefined) el.style.transform = `${el.style.transform || ''} scale(${animProps.scale})`;
                        
                        // è¿”å›ä¸€ä¸ª Promise æ¥å…¼å®¹ .then() è°ƒç”¨
                        return new Promise((resolve) => {
                            setTimeout(resolve, (transProps?.duration || 0.5) * 1000 + (transProps?.delay || 0) * 1000);
                        });
                    }
                };
            }

            // Assign all DOM elements here
            chatMessagesContainer = document.getElementById('chatMessages');
            userInput = document.getElementById('userInput');
            sendButton = document.getElementById('sendButton');
            reportBtn = document.getElementById('reportBtn');
            reportModal = document.getElementById('reportModal');
            closeModalBtn = document.getElementById('closeModal');
            mbtiButton = document.getElementById('mbtiButton');
            mbtiResultDisplay = document.getElementById('mbti-type-display');
            mbtiResultLabelEn = document.getElementById('mbti-type-label-en');
            mbtiProgressContainer = document.getElementById('mbti-progress-container');
            mbtiProgressBar = document.getElementById('mbti-progress-bar');
            mbtiProgressText = document.getElementById('mbti-progress-text');
            
            // Assign MBTI Modal elements here
            mbtiModeModal = document.getElementById('mbtiModeModal');
            mbtiTextModeBtn = document.getElementById('mbtiTextModeBtn');
            mbtiChatModeBtn = document.getElementById('mbtiChatModeBtn');
            mbtiTextModeContent = document.getElementById('mbtiTextModeContent');
            closeMbtiModeModal = document.getElementById('closeMbtiModeModal');


            document.getElementById('currentYear').textContent = new Date().getFullYear();
            const firstBotMessageTime = chatMessagesContainer.querySelector('.message-time');
            if (firstBotMessageTime) {
                firstBotMessageTime.textContent = getCurrentTime();
            }

            setTimeout(applyMotionAnimations, 100); 
            
            setupEventListeners();
            userInput.dispatchEvent(new Event('input'));
        });
    </script> 
</body>
</html>
